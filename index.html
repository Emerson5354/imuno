<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- IMPORTANTE para celular -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Imuno-UNO ‚Äì Guerra do Sistema Imune</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 16px;
      margin-bottom: 8px;
      text-align: center;
      font-size: 22px;
      line-height: 1.2;
      padding: 0 8px;
    }

    #game {
      max-width: 950px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
    }

    .board {
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-radius: 12px;
      padding: 16px;
      background: #020617;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      position: relative;
      overflow: visible;
    }

    .row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .section-title {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .hand {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .card {
      width: 70px;
      height: 100px;
      border-radius: 8px;
      border: 2px solid #111827;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      color: #f9fafb;
      text-align: center;
      padding: 4px;
      box-sizing: border-box;
    }

    .card.player-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 0 rgba(0,0,0,0.5);
      filter: brightness(1.1);
    }

    .card.face-down {
      background: linear-gradient(135deg, #111827, #1f2937);
      color: transparent;
      border-color: #4b5563;
    }

    /* Cores tem√°ticas (n√£o t√™m efeito de regra, s√≥ visual) */
    .card.immune {
      background: #15803d;
    }

    .card.disease-autoimune {
      background: #7c2d12;
    }

    .card.disease-viral {
      background: #1d4ed8;
    }

    .card.disease-bacteriana {
      background: #a16207;
    }

    .card.disease-verme {
      background: #4b5563;
    }

    .card.disease-fungo {
      background: #4c1d95;
    }

    .card.disease-alergia {
      background: #b91c1c;
    }

    .card.selected {
      outline: 3px solid #e5e7eb;
      transform: translateY(-6px);
      box-shadow: 0 8px 0 rgba(0,0,0,0.6);
    }

    .center-area {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .pile-label {
      font-size: 12px;
      opacity: 0.8;
      text-align: center;
      margin-bottom: 4px;
    }

    .small-text {
      font-size: 12px;
      opacity: 0.75;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 4px 0 #15803d;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      font-size: 13px;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-2px);
      box-shadow: 0 5px 0 #15803d;
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #15803d;
    }

    button:disabled {
      background: #4b5563;
      color: #9ca3af;
      box-shadow: 0 0 0 transparent;
      cursor: default;
      transform: none;
    }

    button.secondary {
      background: #1f2937;
      color: #e5e7eb;
      box-shadow: 0 4px 0 #111827;
    }

    #status {
      margin-top: 8px;
      min-height: 40px;
      text-align: center;
      font-size: 14px;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    #top-bar span {
      font-size: 14px;
      opacity: 0.9;
    }

    hr {
      border: none;
      border-top: 1px solid #1f2937;
      margin: 8px 0;
    }

    /* Painel de pr√©-visualiza√ß√£o da carta */
    #cardPreview {
      position: fixed;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.96);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      max-width: 460px;
      width: calc(100% - 16px);
      box-sizing: border-box;
      backdrop-filter: blur(8px);
      border: 1px solid #1f2937;
      display: none;
      z-index: 999;
    }

    #cardPreview.visible {
      display: block;
      animation: slide-up 0.2s ease-out;
    }

    #cardPreviewTitle {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    #cardPreviewDescription {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 8px;
      line-height: 1.4;
      max-height: 40vh;
      overflow-y: auto;
    }

    .card-preview-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Carta voando para a pilha de descarte */
    .flying-card {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
    }

    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translate(-50%, 10px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    /* ===========================
       RESPONSIVIDADE PARA TABLET
       =========================== */
    @media (max-width: 768px) {
      #game {
        padding: 8px;
      }

      .board {
        padding: 12px;
        gap: 12px;
      }

      h1 {
        font-size: 20px;
      }

      .card {
        width: 60px;
        height: 90px;
        font-size: 12px;
      }

      #top-bar span {
        font-size: 13px;
      }

      .section-title {
        font-size: 13px;
      }

      .small-text {
        font-size: 11px;
      }

      button {
        padding: 6px 12px;
        font-size: 12px;
      }
    }

    /* ===========================
       RESPONSIVIDADE PARA CELULAR
       =========================== */
    @media (max-width: 480px) {
      body {
        align-items: stretch;
      }

      #game {
        padding: 8px 6px 80px 6px; /* espa√ßo extra para o preview fixo */
      }

      .board {
        padding: 10px;
        border-radius: 10px;
      }

      h1 {
        font-size: 18px;
      }

      .card {
        width: 52px;
        height: 78px;
        font-size: 11px;
        padding: 2px;
      }

      .hand {
        gap: 6px;
      }

      .center-area {
        gap: 12px;
      }

      #status {
        font-size: 13px;
        min-height: 32px;
      }

      #top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      #top-bar span {
        font-size: 12px;
      }

      .row {
        justify-content: space-between;
      }

      #cardPreview {
        bottom: 6px;
        padding: 10px 12px;
        max-width: 100%;
        width: calc(100% - 12px);
      }

      #cardPreviewDescription {
        font-size: 12px;
      }

      .card.player-card:hover {
        transform: none;
        box-shadow: 0 4px 0 rgba(0,0,0,0.4);
      }
    }
  </style>
</head>
<body>
  <h1>Imuno-UNO ‚Äì Guerra do Sistema Imune</h1>
  <div id="game">
    <div id="top-bar">
      <span>Jogador (voc√™) üß¨ vs ü§ñ Pat√≥geno Bot</span>
      <button id="newGameBtn">Novo jogo</button>
    </div>

    <div class="board">
      <!-- M√£o do bot -->
      <div>
        <div class="section-title">M√£o do Bot</div>
        <div id="botHand" class="hand"></div>
      </div>

      <hr />

      <!-- Centro: pilha de compra / descarte -->
      <div class="center-area">
        <div>
          <div class="pile-label">Pilha de compra</div>
          <div id="drawPileCard" class="card face-down"></div>
          <div class="small-text" id="deckSizeInfo"></div>
        </div>

        <div>
          <div class="pile-label">√öltima carta jogada</div>
          <div id="discardPileCard" class="card"></div>
          <div class="small-text" id="lastCardInfo"></div>
        </div>
      </div>

      <!-- Status / mensagens -->
      <div id="status"></div>

      <hr />

      <!-- M√£o do jogador -->
      <div>
        <div class="section-title">
          Sua m√£o
          <span class="small-text">(clique em uma carta para ver a explica√ß√£o e decidir jogar)</span>
        </div>
        <div id="playerHand" class="hand"></div>
      </div>

      <!-- Controles do jogador -->
      <div class="row">
        <button id="drawBtn">Comprar carta</button>
        <span class="small-text">
          Turno atual: <span id="turnInfo"></span>
          ‚Ä¢ Situa√ß√£o: <span id="phaseInfo"></span>
        </span>
      </div>
    </div>
  </div>

  <!-- Painel de pr√©-visualiza√ß√£o da carta escolhida -->
  <div id="cardPreview">
    <div id="cardPreviewTitle">Carta selecionada</div>
    <div id="cardPreviewDescription"></div>
    <div class="card-preview-actions">
      <button id="cancelSelectedBtn" class="secondary">Escolher outra carta</button>
      <button id="playSelectedBtn">Jogar carta</button>
    </div>
  </div>

  <script>
    // ------------------------------
    // DEFINI√á√ïES DO BARALHO
    // ------------------------------

    // Cartas do Sistema Imune
    const IMMUNE_CARDS = [
      {
        id: "neutrofilo",
        name: "Neutr√≥filo",
        short: "Neutr√≥filo",
        role: "neutrofilo",
        kind: "immune",
        description: "Neutr√≥filo √© o soldado da linha de frente contra bact√©rias e alguns fungos."
      },
      {
        id: "macrofago",
        name: "Macr√≥fago",
        short: "Macr√≥fago",
        role: "macrofago",
        kind: "immune",
        description: "Macr√≥fago engole invasores e mostra peda√ßos deles para outras c√©lulas de defesa."
      },
      {
        id: "th1",
        name: "Linf√≥cito Th1",
        short: "Th1",
        role: "th1",
        kind: "immune",
        description: "Th1 organiza respostas contra v√≠rus, bact√©rias e fungos que se escondem dentro das c√©lulas."
      },
      {
        id: "th2",
        name: "Linf√≥cito Th2",
        short: "Th2",
        role: "th2",
        kind: "immune",
        description: "Th2 organiza a defesa contra vermes e participa de alergias."
      },
      {
        id: "th17",
        name: "Linf√≥cito Th17",
        short: "Th17",
        role: "th17",
        kind: "immune",
        description: "Th17 √© importante na defesa de mucosas e em inflama√ß√µes intensas, como psor√≠ase."
      },
      {
        id: "treg",
        name: "Linf√≥cito Treg",
        short: "Treg",
        role: "treg",
        kind: "immune",
        description: "Treg √© o freio do sistema imune, ajudando a evitar ataques contra o pr√≥prio corpo."
      },
      {
        id: "tcito",
        name: "Linf√≥cito T citot√≥xico",
        short: "T CD8+",
        role: "tcito",
        kind: "immune",
        description: "Linf√≥cito T citot√≥xico destr√≥i c√©lulas infectadas por v√≠rus."
      },
      {
        id: "b",
        name: "Linf√≥cito B",
        short: "Linf√≥cito B",
        role: "b",
        kind: "immune",
        description: "Linf√≥cito B produz anticorpos, que marcam invasores para serem destru√≠dos."
      },
      {
        id: "mastocito",
        name: "Mast√≥cito",
        short: "Mast√≥cito",
        role: "mastocito",
        kind: "immune",
        description: "Mast√≥cito √© o mago das alergias, liberando histamina e outras subst√¢ncias."
      },
      {
        id: "eosinofilo",
        name: "Eosin√≥filo",
        short: "Eosin√≥filo",
        role: "eosinofilo",
        kind: "immune",
        description: "Eosin√≥filo ataca vermes e participa de alergias mais prolongadas."
      }
    ];

    // Cartas de Doen√ßas
    const DISEASE_CARDS = [
      // Autoimunes (todas s√≥ defendem com Treg, ludicamente)
      {
        id: "dm1",
        name: "Diabetes tipo 1",
        short: "DM1",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description: "Autoimune: o corpo ataca as c√©lulas beta do p√¢ncreas. S√≥ Treg acalma essa confus√£o."
      },
      {
        id: "psoriase",
        name: "Psor√≠ase",
        short: "Psor√≠ase",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description: "Autoimune de pele, ligada a inflama√ß√£o intensa. Treg ajudaria a frear."
      },
      {
        id: "anemia_autoimune",
        name: "Anemia hemol√≠tica autoimune",
        short: "Anemia AI",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description: "Autoimune: anticorpos atacam as hem√°cias. Treg tenta acalmar a resposta."
      },
      {
        id: "em",
        name: "Esclerose m√∫ltipla",
        short: "EM",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description: "Autoimune contra a mielina dos neur√¥nios. Treg ajudaria a conter o ataque."
      },
      {
        id: "lupus",
        name: "L√∫pus eritematoso sist√™mico",
        short: "L√∫pus",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description: "Autoimune sist√™mico com muitos autoanticorpos. Treg √© a carta calmante."
      },

      // Virais ‚Äì todos usam T citot√≥xico, Th1, macr√≥fago, B
      {
        id: "gripe",
        name: "Gripe (Influenza)",
        short: "Gripe",
        category: "viral",
        kind: "disease",
        effectiveRoles: ["tcito", "th1", "macrofago", "b"],
        description: "V√≠rus respirat√≥rio. Defesa com T citot√≥xico, Th1, macr√≥fago e anticorpos."
      },
      {
        id: "covid",
        name: "COVID-19",
        short: "COVID",
        category: "viral",
        kind: "disease",
        effectiveRoles: ["tcito", "th1", "macrofago", "b"],
        description: "Infec√ß√£o viral respirat√≥ria. Defesa com T citot√≥xico, Th1, macr√≥fago e anticorpos."
      },
      {
        id: "dengue",
        name: "Dengue",
        short: "Dengue",
        category: "viral",
        kind: "disease",
        effectiveRoles: ["tcito", "th1", "macrofago", "b"],
        description: "V√≠rus transmitido por mosquito. Defesa com T citot√≥xico, Th1, macr√≥fago e anticorpos."
      },
      {
        id: "herpes",
        name: "Herpes",
        short: "Herpes",
        category: "viral",
        kind: "disease",
        effectiveRoles: ["tcito", "th1", "macrofago", "b"],
        description: "V√≠rus que pode ficar latente. Defesa com T citot√≥xico, Th1, macr√≥fagos e anticorpos."
      },
      {
        id: "hepatite_c",
        name: "Hepatite C",
        short: "Hepatite C",
        category: "viral",
        kind: "disease",
        effectiveRoles: ["tcito", "th1", "macrofago", "b"],
        description: "V√≠rus que ataca o f√≠gado. Defesa com T citot√≥xico, Th1, macr√≥fagos e anticorpos."
      },

      // Bact√©rias
      {
        id: "tuberculose",
        name: "Tuberculose",
        short: "TB",
        category: "bacteriana",
        kind: "disease",
        effectiveRoles: ["th1", "macrofago"],
        description: "Bact√©ria que se esconde dentro de macr√≥fagos. Th1 e macr√≥fago s√£o essenciais."
      },
      {
        id: "tetano",
        name: "T√©tano",
        short: "T√©tano",
        category: "bacteriana",
        kind: "disease",
        effectiveRoles: ["neutrofilo", "macrofago", "b"],
        description: "Bact√©ria que libera toxina. Neutr√≥filos, macr√≥fagos e anticorpos ajudam."
      },
      {
        id: "botulismo",
        name: "Botulismo",
        short: "Botulismo",
        category: "bacteriana",
        kind: "disease",
        effectiveRoles: ["neutrofilo", "macrofago", "b"],
        description: "Bact√©ria produtora de toxina. Defesa com neutr√≥filos, macr√≥fagos e anticorpos."
      },
      {
        id: "itu",
        name: "Infec√ß√£o urin√°ria",
        short: "ITU",
        category: "bacteriana",
        kind: "disease",
        effectiveRoles: ["neutrofilo", "macrofago", "b"],
        description: "Bact√©ria no trato urin√°rio. Neutr√≥filos, macr√≥fagos e anticorpos participam."
      },
      {
        id: "sifilis",
        name: "S√≠filis",
        short: "S√≠filis",
        category: "bacteriana",
        kind: "disease",
        effectiveRoles: ["neutrofilo", "macrofago", "b"],
        description: "Bact√©ria espiroqueta. Defesa com neutr√≥filos, macr√≥fagos e anticorpos."
      },

      // Vermes
      {
        id: "ascaridiase",
        name: "Ascarid√≠ase",
        short: "Ascarid√≠ase",
        category: "verme",
        kind: "disease",
        effectiveRoles: ["eosinofilo", "mastocito", "th2", "b"],
        description: "Vermes intestinais. Defesa com eosin√≥filos, mast√≥citos, Th2 e IgE (B)."
      },
      {
        id: "teniase",
        name: "Ten√≠ase",
        short: "Ten√≠ase",
        category: "verme",
        kind: "disease",
        effectiveRoles: ["eosinofilo", "mastocito", "th2", "b"],
        description: "Verme intestinal. Eosin√≥filos, mast√≥citos, Th2 e IgE (B) ajudam na expuls√£o."
      },
      {
        id: "esquistossomose",
        name: "Esquistossomose",
        short: "Esquisto",
        category: "verme",
        kind: "disease",
        effectiveRoles: ["eosinofilo", "mastocito", "th2", "b"],
        description: "Vermes no sistema porta hep√°tico. Defesa com eosin√≥filos, mast√≥citos, Th2 e IgE."
      },

      // Fungos
      {
        id: "histoplasmose",
        name: "Histoplasmose",
        short: "Histoplasmose",
        category: "fungo",
        kind: "disease",
        effectiveRoles: ["th1", "macrofago", "neutrofilo"],
        description: "Fungo que pode viver dentro de c√©lulas. Th1, macr√≥fagos e neutr√≥filos s√£o importantes."
      },
      {
        id: "candidiase",
        name: "Candid√≠ase",
        short: "Candid√≠ase",
        category: "fungo",
        kind: "disease",
        effectiveRoles: ["th17", "neutrofilo"],
        description: "Fungo de mucosa. Th17 e neutr√≥filos s√£o chave na defesa."
      },

      // Alergias
      {
        id: "rinite",
        name: "Rinite al√©rgica",
        short: "Rinite",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "th2", "b"],
        description: "Alergia nasal. Mast√≥citos, eosin√≥filos, Th2 e IgE participam."
      },
      {
        id: "alergia",
        name: "Alergia",
        short: "Alergia",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "th2", "b"],
        description: "Rea√ß√£o exagerada a algo comum. Mast√≥citos, eosin√≥filos, Th2 e IgE atuam."
      },
      {
        id: "anafilaxia",
        name: "Anafilaxia",
        short: "Anafilaxia",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "th2", "b"],
        description: "Alergia grave e r√°pida. Mast√≥citos s√£o centrais, com eosin√≥filos, Th2 e IgE."
      },
      {
        id: "dermatite_atopica",
        name: "Dermatite at√≥pica",
        short: "Dermatite",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "th2", "b"],
        description: "Alergia de pele cr√¥nica. Mast√≥citos, eosin√≥filos, Th2 e IgE est√£o envolvidos."
      }
    ];

    // ------------------------------
    // ESTADO DO JOGO
    // ------------------------------
    let deck = [];
    let discardPile = [];
    let players = [];
    let currentPlayer = 0; // 0 = voc√™, 1 = bot
    let gameOver = false;
    let selectedCardIndex = null;

    // Ataque pendente: doen√ßa lan√ßada que algu√©m precisa defender
    // { targetIndex: 0 ou 1, diseaseCard: {...} }
    let pendingAttack = null;

    // ------------------------------
    // UTILIT√ÅRIAS
    // ------------------------------
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createDeck() {
      const newDeck = [];

      // V√°rias c√≥pias das c√©lulas
      IMMUNE_CARDS.forEach(cardDef => {
        for (let i = 0; i < 4; i++) {
          newDeck.push({ ...cardDef });
        }
      });

      // Algumas c√≥pias das doen√ßas
      DISEASE_CARDS.forEach(cardDef => {
        for (let i = 0; i < 2; i++) {
          newDeck.push({ ...cardDef });
        }
      });

      return shuffle(newDeck);
    }

    function drawCardFromDeck() {
      if (deck.length === 0) {
        if (discardPile.length > 1) {
          const top = discardPile.pop();
          deck = shuffle(discardPile);
          discardPile = [top];
        } else {
          return null;
        }
      }
      return deck.pop();
    }

    function isImmuneCard(card) {
      return card && card.kind === "immune";
    }

    function isDiseaseCard(card) {
      return card && card.kind === "disease";
    }

    function isEffectiveDefense(immuneCard, diseaseCard) {
      if (!immuneCard || !diseaseCard) return false;
      if (!isImmuneCard(immuneCard) || !isDiseaseCard(diseaseCard)) return false;
      return diseaseCard.effectiveRoles.includes(immuneCard.role);
    }

    function cardCssClass(card) {
      if (!card) return "card";
      if (isImmuneCard(card)) return "card immune";
      // Doen√ßas por categoria
      switch (card.category) {
        case "autoimune":  return "card disease-autoimune";
        case "viral":      return "card disease-viral";
        case "bacteriana": return "card disease-bacteriana";
        case "verme":      return "card disease-verme";
        case "fungo":      return "card disease-fungo";
        case "alergia":    return "card disease-alergia";
        default:           return "card";
      }
    }

    function describeCategory(card) {
      if (!card || !isDiseaseCard(card)) return "";
      switch (card.category) {
        case "autoimune":  return "Doen√ßa autoimune";
        case "viral":      return "Doen√ßa viral";
        case "bacteriana": return "Doen√ßa bacteriana";
        case "verme":      return "Infec√ß√£o por verme (helminto)";
        case "fungo":      return "Infec√ß√£o f√∫ngica";
        case "alergia":    return "Doen√ßa al√©rgica";
        default:           return "";
      }
    }

    // Efeito especial: Th1/Th2/Th17 descartam outras c√©lulas
    function applyThMassDiscard(playerIndex, card) {
      if (!card || !isImmuneCard(card)) return;
      const player = players[playerIndex];
      if (!player) return;

      let roleToDiscard = null;
      if (card.role === "th1") {
        roleToDiscard = "macrofago";
      } else if (card.role === "th2") {
        roleToDiscard = "eosinofilo";
      } else if (card.role === "th17") {
        roleToDiscard = "neutrofilo";
      }

      if (!roleToDiscard) return;

      const remaining = [];
      player.hand.forEach(c => {
        if (c.role === roleToDiscard) {
          discardPile.push(c);
        } else {
          remaining.push(c);
        }
      });
      player.hand = remaining;
    }

    // ------------------------------
    // CONTROLE DE JOGO
    // ------------------------------
    function dealInitialHands() {
      players = [
        { name: "Voc√™", hand: [] },
        { name: "Bot", hand: [] }
      ];

      const initialCards = 7;
      for (let i = 0; i < initialCards; i++) {
        players[0].hand.push(drawCardFromDeck());
        players[1].hand.push(drawCardFromDeck());
      }

      // Primeira carta de descarte: preferir c√©lula (para n√£o come√ßar com doen√ßa atacando)
      let firstCard = drawCardFromDeck();
      let tries = 0;
      while (firstCard && isDiseaseCard(firstCard) && tries < 20) {
        deck.unshift(firstCard);
        firstCard = drawCardFromDeck();
        tries++;
      }

      if (firstCard) {
        discardPile = [firstCard];
      } else {
        discardPile = [];
      }

      pendingAttack = null;
    }

    function startGame() {
      deck = createDeck();
      discardPile = [];
      gameOver = false;
      currentPlayer = 0;
      selectedCardIndex = null;
      pendingAttack = null;
      hideCardPreview();

      dealInitialHands();
      updateStatus("O jogo come√ßou. Seu objetivo √© ficar sem cartas na m√£o.");
      render();

      if (currentPlayer === 1 && !gameOver) {
        setTimeout(botTurn, 600);
      }
    }

    function checkWin(playerIndex) {
      if (players[playerIndex].hand.length === 0) {
        gameOver = true;
        if (playerIndex === 0) {
          updateStatus("Voc√™ ficou sem cartas na m√£o. Vit√≥ria do sistema imune humano!");
        } else {
          updateStatus("O bot ficou sem cartas. O pat√≥geno venceu desta vez.");
        }
      }
    }

    function endTurn() {
      if (gameOver) return;
      currentPlayer = (currentPlayer + 1) % players.length;
      selectedCardIndex = null;
      hideCardPreview();
      render();

      if (currentPlayer === 1 && !gameOver) {
        setTimeout(botTurn, 700);
      } else if (!gameOver) {
        if (pendingAttack && pendingAttack.targetIndex === 0) {
          updateStatus(
            "Voc√™ est√° sob ataque de " + pendingAttack.diseaseCard.name +
            ". Jogue uma carta de defesa √∫til ou compre 1 carta."
          );
        } else {
          updateStatus("Seu turno.");
        }
      }
    }

    // ------------------------------
    // A√á√ïES DO JOGADOR
    // ------------------------------
    function canPlayCardForCurrentState(card) {
      if (gameOver || currentPlayer !== 0) return false;
      if (!card) return false;

      if (pendingAttack && pendingAttack.targetIndex === 0) {
        // Sob ataque: s√≥ pode jogar cartas do sistema imune para tentar defender
        return isImmuneCard(card);
      }
      // Sem ataque: pode jogar qualquer carta
      return true;
    }

    function handlePlayerCardClick(index) {
      if (gameOver || currentPlayer !== 0) return;
      const player = players[0];
      const card = player.hand[index];
      selectedCardIndex = index;
      showCardPreview(card);
      renderPlayerHand();
    }

    function playerPlaySelectedCard() {
      if (selectedCardIndex === null) return;
      const player = players[0];
      const card = player.hand[selectedCardIndex];
      if (!canPlayCardForCurrentState(card)) {
        updateStatus("Esta carta n√£o pode ser jogada neste momento.");
        return;
      }
      playCard(0, selectedCardIndex);
    }

    function playerDrawCard() {
      if (gameOver || currentPlayer !== 0) return;
      const player = players[0];

      if (pendingAttack && pendingAttack.targetIndex === 0) {
        // Jogador decide n√£o se defender: toma o dano da doen√ßa
        const newCard = drawCardFromDeck();
        if (newCard) {
          player.hand.push(newCard);
          updateStatus(
            "Voc√™ n√£o se defendeu de " + pendingAttack.diseaseCard.name +
            " e comprou 1 carta."
          );
        } else {
          updateStatus("N√£o h√° mais cartas para comprar.");
        }
        pendingAttack = null;
        render();
        endTurn();
        return;
      }

      // Situa√ß√£o normal: apenas compra e passa o turno
      const newCard = drawCardFromDeck();
      if (newCard) {
        player.hand.push(newCard);
        updateStatus("Voc√™ comprou 1 carta e passou o turno.");
      } else {
        updateStatus("N√£o h√° mais cartas para comprar.");
      }
      render();
      endTurn();
    }

    // ------------------------------
    // L√ìGICA DE JOGAR CARTA (comum a jogador e bot)
    // ------------------------------
    function playCard(playerIndex, cardIndex, sourceElementForAnimation) {
      if (gameOver) return;
      const player = players[playerIndex];
      const card = player.hand[cardIndex];
      if (!card) return;

      // Anima√ß√£o
      if (sourceElementForAnimation) {
        animateCardToDiscard(sourceElementForAnimation, card);
      }

      // Remove da m√£o
      player.hand.splice(cardIndex, 1);
      discardPile.push(card);

      // Efeito especial de Th1 / Th2 / Th17 (descarta macr√≥fagos / eosin√≥filos / neutr√≥filos)
      applyThMassDiscard(playerIndex, card);

      // Se o jogador est√° sob ataque, isso √© uma tentativa de defesa
      if (pendingAttack && pendingAttack.targetIndex === playerIndex) {
        resolveDefense(playerIndex, card);
        return;
      }

      // Caso geral: ningu√©m estava sob ataque, √© um ataque novo ou s√≥ descarte
      if (isDiseaseCard(card)) {
        // Doen√ßa atacando o outro jogador
        const target = (playerIndex + 1) % players.length;
        pendingAttack = {
          targetIndex: target,
          diseaseCard: card
        };
        updateStatus(
          player.name + " lan√ßou a doen√ßa " + card.name +
          " contra " + players[target].name + "."
        );
      } else {
        // C√©lula jogada fora de contexto de defesa: apenas descarte l√∫dico
        updateStatus(player.name + " jogou a c√©lula " + card.name + ".");
      }

      checkWin(playerIndex);
      render();
      if (!gameOver) {
        endTurn();
      }
    }

    // Resolve quando algu√©m joga carta durante ataque
    function resolveDefense(playerIndex, immuneCard) {
      const attack = pendingAttack;
      pendingAttack = null; // ataque vai ser resolvido agora

      const opponentIndex = (playerIndex + 1) % players.length;
      const defender = players[playerIndex];
      const opponent = players[opponentIndex];

      if (!isImmuneCard(immuneCard)) {
        // Jogou algo que n√£o √© c√©lula (na pr√°tica n√£o deve acontecer, mas fica por seguran√ßa)
        const newCard = drawCardFromDeck();
        if (newCard) defender.hand.push(newCard);
        updateStatus(
          defender.name +
          " tentou se defender com uma carta inv√°lida e comprou 1 carta."
        );
        render();
        endTurn();
        return;
      }

      const effective = isEffectiveDefense(immuneCard, attack.diseaseCard);

      if (effective) {
        // Primeiro verifica se o defensor j√° ganhou ao jogar a carta
        checkWin(playerIndex);
        if (gameOver) {
          render();
          return;
        }

        // Ataque foi revertido: o oponente compra 1 carta
        const newCard = drawCardFromDeck();
        if (newCard) opponent.hand.push(newCard);
        updateStatus(
          defender.name +
          " se defendeu com " + immuneCard.name +
          " contra " + attack.diseaseCard.name +
          ". O atacante (" + opponent.name + ") comprou 1 carta."
        );
      } else {
        // Defesa falhou: o defensor compra 1 carta
        const newCard = drawCardFromDeck();
        if (newCard) defender.hand.push(newCard);
        updateStatus(
          defender.name +
          " tentou se defender com " + immuneCard.name +
          " contra " + attack.diseaseCard.name +
          ", mas n√£o foi eficaz. " +
          defender.name + " comprou 1 carta."
        );
      }

      render();
      if (!gameOver) {
        endTurn();
      }
    }

    // ------------------------------
    // TURNO DO BOT
    // ------------------------------
    function botTurn() {
      if (gameOver || currentPlayer !== 1) return;
      const bot = players[1];

      // Se o bot est√° sob ataque, tenta se defender
      if (pendingAttack && pendingAttack.targetIndex === 1) {
        const disease = pendingAttack.diseaseCard;

        // 1¬∫ tenta achar uma carta eficaz
        let effectiveIndex = -1;
        for (let i = 0; i < bot.hand.length; i++) {
          const card = bot.hand[i];
          if (isImmuneCard(card) && isEffectiveDefense(card, disease)) {
            effectiveIndex = i;
            break;
          }
        }

        if (effectiveIndex !== -1) {
          const cardEl = botHandEl.children[effectiveIndex];
          playCard(1, effectiveIndex, cardEl);
          return;
        }

        // 2¬∫ se n√£o tem eficaz, tenta qualquer c√©lula
        let anyImmuneIndex = -1;
        for (let i = 0; i < bot.hand.length; i++) {
          const card = bot.hand[i];
          if (isImmuneCard(card)) {
            anyImmuneIndex = i;
            break;
          }
        }

        if (anyImmuneIndex !== -1) {
          const cardEl = botHandEl.children[anyImmuneIndex];
          playCard(1, anyImmuneIndex, cardEl);
          return;
        }

        // 3¬∫ n√£o tem defesa: compra 1 carta e encerra o ataque
        const newCard = drawCardFromDeck();
        if (newCard) bot.hand.push(newCard);
        updateStatus(
          "Bot n√£o conseguiu se defender de " + disease.name +
          " e comprou 1 carta."
        );
        pendingAttack = null;
        render();
        endTurn();
        return;
      }

      // Se n√£o est√° sob ataque: decide ataque
      // Prioridade: jogar doen√ßa
      let diseaseIndex = -1;
      for (let i = 0; i < bot.hand.length; i++) {
        if (isDiseaseCard(bot.hand[i])) {
          diseaseIndex = i;
          break;
        }
      }

      if (diseaseIndex !== -1) {
        const cardEl = botHandEl.children[diseaseIndex];
        playCard(1, diseaseIndex, cardEl);
        return;
      }

      // Se n√£o tem doen√ßa, joga qualquer c√©lula (tenta usar Th primeiro para descartar mais)
      let thIndex = -1;
      let anyImmuneIndex = -1;
      for (let i = 0; i < bot.hand.length; i++) {
        const card = bot.hand[i];
        if (isImmuneCard(card)) {
          if ((card.role === "th1" || card.role === "th2" || card.role === "th17") && thIndex === -1) {
            thIndex = i;
          }
          if (anyImmuneIndex === -1) anyImmuneIndex = i;
        }
      }

      if (thIndex !== -1) {
        const cardEl = botHandEl.children[thIndex];
        playCard(1, thIndex, cardEl);
        return;
      }

      if (anyImmuneIndex !== -1) {
        const cardEl = botHandEl.children[anyImmuneIndex];
        playCard(1, anyImmuneIndex, cardEl);
        return;
      }

      // Se n√£o tem nada para jogar, compra 1 carta
      const newCard = drawCardFromDeck();
      if (newCard) {
        bot.hand.push(newCard);
        updateStatus("Bot comprou 1 carta e passou o turno.");
      } else {
        updateStatus("Bot tentou comprar carta, mas n√£o havia mais no baralho.");
      }
      render();
      endTurn();
    }

    // ------------------------------
    // INTERFACE / DOM
    // ------------------------------
    const playerHandEl = document.getElementById("playerHand");
    const botHandEl = document.getElementById("botHand");
    const discardPileCardEl = document.getElementById("discardPileCard");
    const drawPileCardEl = document.getElementById("drawPileCard");
    const statusEl = document.getElementById("status");
    const deckSizeInfoEl = document.getElementById("deckSizeInfo");
    const turnInfoEl = document.getElementById("turnInfo");
    const phaseInfoEl = document.getElementById("phaseInfo");
    const drawBtnEl = document.getElementById("drawBtn");
    const newGameBtnEl = document.getElementById("newGameBtn");
    const lastCardInfoEl = document.getElementById("lastCardInfo");

    const cardPreviewEl = document.getElementById("cardPreview");
    const cardPreviewDescriptionEl = document.getElementById("cardPreviewDescription");
    const cardPreviewTitleEl = document.getElementById("cardPreviewTitle");
    const playSelectedBtn = document.getElementById("playSelectedBtn");
    const cancelSelectedBtn = document.getElementById("cancelSelectedBtn");

    function updateStatus(text) {
      statusEl.textContent = text;
    }

    function render() {
      renderPlayerHand();
      renderBotHand();

      const top = discardPile[discardPile.length - 1];
      if (top) {
        discardPileCardEl.className = cardCssClass(top);
        discardPileCardEl.textContent = top.short || top.name;
        if (isDiseaseCard(top)) {
          lastCardInfoEl.textContent = describeCategory(top);
        } else {
          lastCardInfoEl.textContent = "C√©lula imune jogada.";
        }
      } else {
        discardPileCardEl.className = "card";
        discardPileCardEl.textContent = "";
        lastCardInfoEl.textContent = "";
      }

      drawPileCardEl.className = "card face-down";
      deckSizeInfoEl.textContent = `Cartas restantes: ${deck.length}`;
      turnInfoEl.textContent = players[currentPlayer]?.name || "";

      if (pendingAttack) {
        const targetName = players[pendingAttack.targetIndex].name;
        const diseaseName = pendingAttack.diseaseCard.name;
        phaseInfoEl.textContent = `Ataque: ${diseaseName} em ${targetName}`;
      } else {
        phaseInfoEl.textContent = "Sem ataque ativo";
      }

      drawBtnEl.disabled = gameOver || currentPlayer !== 0;
    }

    function renderPlayerHand() {
      playerHandEl.innerHTML = "";
      const player = players[0];
      if (!player) return;

      player.hand.forEach((card, index) => {
        const cardDiv = document.createElement("div");
        let cls = cardCssClass(card) + " player-card";
        if (index === selectedCardIndex) {
          cls += " selected";
        }
        cardDiv.className = cls;
        cardDiv.textContent = card.short || card.name;
        cardDiv.title = "Clique para saber mais e decidir jogar";
        cardDiv.addEventListener("click", () => handlePlayerCardClick(index));
        playerHandEl.appendChild(cardDiv);
      });
    }

    function renderBotHand() {
      botHandEl.innerHTML = "";
      const bot = players[1];
      if (!bot) return;

      bot.hand.forEach(() => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card face-down";
        botHandEl.appendChild(cardDiv);
      });
    }

    // Anima√ß√£o de carta voando
    function animateCardToDiscard(fromElement, card) {
      if (!fromElement || !discardPileCardEl) return;

      const fromRect = fromElement.getBoundingClientRect();
      const toRect = discardPileCardEl.getBoundingClientRect();

      const flying = document.createElement("div");
      flying.className = cardCssClass(card) + " flying-card";
      flying.textContent = card.short || card.name;
      flying.style.left = fromRect.left + "px";
      flying.style.top = fromRect.top + "px";

      document.body.appendChild(flying);

      const dx = toRect.left - fromRect.left;
      const dy = toRect.top - fromRect.top;

      requestAnimationFrame(() => {
        flying.style.transform = `translate(${dx}px, ${dy}px) scale(0.9)`;
        flying.style.opacity = "0.1";
      });

      flying.addEventListener("transitionend", () => {
        flying.remove();
      });
    }

    // ------------------------------
    // PR√â-VISUALIZA√á√ÉO DA CARTA
    // ------------------------------
    function showCardPreview(card) {
      if (!card) return;

      cardPreviewTitleEl.textContent = card.name;

      let baseInfo = "";

      if (isImmuneCard(card)) {
        baseInfo += `<strong>Tipo:</strong> C√©lula do sistema imune<br/>`;
        baseInfo += `<strong>Fun√ß√£o l√∫dica:</strong> ${card.description}<br/>`;

        if (card.role === "th1") {
          baseInfo += `<strong>Efeito especial:</strong> ao jogar Th1 fora de defesa, voc√™ descarta todos os seus Macr√≥fagos junto com ele.<br/>`;
        } else if (card.role === "th2") {
          baseInfo += `<strong>Efeito especial:</strong> ao jogar Th2 fora de defesa, voc√™ descarta todos os seus Eosin√≥filos junto com ele.<br/>`;
        } else if (card.role === "th17") {
          baseInfo += `<strong>Efeito especial:</strong> ao jogar Th17 fora de defesa, voc√™ descarta todos os seus Neutr√≥filos junto com ele.<br/>`;
        }
      } else if (isDiseaseCard(card)) {
        baseInfo += `<strong>Tipo:</strong> ${describeCategory(card)}<br/>`;
        baseInfo += `<strong>Descri√ß√£o l√∫dica:</strong> ${card.description}<br/>`;
        baseInfo += `<br/><strong>Defesas eficazes:</strong> `;
        const roles = card.effectiveRoles.map(r => {
          const def = IMMUNE_CARDS.find(c => c.role === r);
          return def ? def.name : r;
        });
        baseInfo += roles.join(", ") + ".<br/>";
        baseInfo += `<br/>Se voc√™ jogar esta carta em algu√©m, ele ficar√° sob ataque e ter√° que se defender com uma dessas c√©lulas ou comprar 1 carta.`;
      }

      // Se existe ataque ativo e voc√™ √© o alvo, explicar se esta carta ajuda
      if (pendingAttack && pendingAttack.targetIndex === 0 && isImmuneCard(card)) {
        const disease = pendingAttack.diseaseCard;
        const effective = isEffectiveDefense(card, disease);
        baseInfo += `<hr/>`;
        baseInfo += `<strong>Situa√ß√£o atual:</strong> Voc√™ est√° sob ataque de <em>${disease.name}</em>.<br/>`;
        if (effective) {
          baseInfo += `<strong>Resultado se jogar esta carta agora:</strong> defesa BEM-SUCEDIDA. O oponente comprar√° 1 carta e o ataque acaba.<br/>`;
        } else {
          baseInfo += `<strong>Resultado se jogar esta carta agora:</strong> defesa FALHOU. Voc√™ ter√° que comprar 1 carta mesmo assim e o ataque acaba.<br/>`;
        }
      }

      cardPreviewDescriptionEl.innerHTML = baseInfo;

      const canPlay = canPlayCardForCurrentState(card);
      playSelectedBtn.disabled = !canPlay;

      cardPreviewEl.classList.add("visible");
    }

    function hideCardPreview() {
      cardPreviewEl.classList.remove("visible");
    }

    // ------------------------------
    // EVENTOS
    // ------------------------------
    drawBtnEl.addEventListener("click", playerDrawCard);
    newGameBtnEl.addEventListener("click", startGame);
    playSelectedBtn.addEventListener("click", playerPlaySelectedCard);
    cancelSelectedBtn.addEventListener("click", () => {
      selectedCardIndex = null;
      hideCardPreview();
      renderPlayerHand();
    });

    // Inicia o jogo ao carregar
    startGame();
  </script>
</body>
</html>
