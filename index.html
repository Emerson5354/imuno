<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- IMPORTANTE para celular -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Imuno-UNO ‚Äì Guerra do Sistema Imune</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 16px;
      margin-bottom: 8px;
      text-align: center;
      font-size: 22px;
      line-height: 1.2;
      padding: 0 8px;
    }

    #game {
      max-width: 950px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
    }

    .board {
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-radius: 12px;
      padding: 16px;
      background: #020617;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      position: relative;
      overflow: visible;
    }

    .row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .section-title {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .hand {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .card {
      width: 70px;
      height: 100px;
      border-radius: 8px;
      border: 2px solid #111827;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      color: #f9fafb;
      text-align: center;
      padding: 4px;
      box-sizing: border-box;
    }

    .card.player-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 0 rgba(0,0,0,0.5);
      filter: brightness(1.1);
    }

    .card.face-down {
      background: linear-gradient(135deg, #111827, #1f2937);
      color: transparent;
      border-color: #4b5563;
    }

    /* Cores tem√°ticas (n√£o t√™m efeito de regra, s√≥ visual) */
    .card.immune {
      background: #15803d;
    }

    .card.disease-autoimune {
      background: #7c2d12;
    }

    .card.disease-viral {
      background: #1d4ed8;
    }

    .card.disease-bacteriana {
      background: #a16207;
    }

    .card.disease-verme {
      background: #4b5563;
    }

    .card.disease-fungo {
      background: #4c1d95;
    }

    .card.disease-alergia {
      background: #b91c1c;
    }

    .card.selected {
      outline: 3px solid #e5e7eb;
      transform: translateY(-6px);
      box-shadow: 0 8px 0 rgba(0,0,0,0.6);
    }

    .center-area {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
    }

    .pile-label {
      font-size: 12px;
      opacity: 0.8;
      text-align: center;
      margin-bottom: 4px;
    }

    .small-text {
      font-size: 12px;
      opacity: 0.75;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 4px 0 #15803d;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      font-size: 13px;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-2px);
      box-shadow: 0 5px 0 #15803d;
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 0 #15803d;
    }

    button:disabled {
      background: #4b5563;
      color: #9ca3af;
      box-shadow: 0 0 0 transparent;
      cursor: default;
      transform: none;
    }

    button.secondary {
      background: #1f2937;
      color: #e5e7eb;
      box-shadow: 0 4px 0 #111827;
    }

    #status {
      margin-top: 8px;
      min-height: 40px;
      text-align: center;
      font-size: 14px;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    #top-bar span {
      font-size: 14px;
      opacity: 0.9;
    }

    hr {
      border: none;
      border-top: 1px solid #1f2937;
      margin: 8px 0;
    }

    /* Painel de pr√©-visualiza√ß√£o da carta */
    #cardPreview {
      position: fixed;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.96);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      max-width: 460px;
      width: calc(100% - 16px);
      box-sizing: border-box;
      backdrop-filter: blur(8px);
      border: 1px solid #1f2937;
      display: none;
      z-index: 999;
    }

    #cardPreview.visible {
      display: block;
      animation: slide-up 0.2s ease-out;
    }

    #cardPreviewTitle {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    #cardPreviewDescription {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 8px;
      line-height: 1.4;
      max-height: 40vh;
      overflow-y: auto;
    }

    .card-preview-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Carta voando para a pilha de descarte */
    .flying-card {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
    }

    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translate(-50%, 10px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    /* ===========================
       RESPONSIVIDADE PARA TABLET
       =========================== */
    @media (max-width: 768px) {
      #game {
        padding: 8px;
      }

      .board {
        padding: 12px;
        gap: 12px;
      }

      h1 {
        font-size: 20px;
      }

      .card {
        width: 60px;
        height: 90px;
        font-size: 12px;
      }

      #top-bar span {
        font-size: 13px;
      }

      .section-title {
        font-size: 13px;
      }

      .small-text {
        font-size: 11px;
      }

      button {
        padding: 6px 12px;
        font-size: 12px;
      }
    }

    /* ===========================
       RESPONSIVIDADE PARA CELULAR
       =========================== */
    @media (max-width: 480px) {
      body {
        align-items: stretch;
      }

      #game {
        padding: 8px 6px 80px 6px; /* espa√ßo extra para o preview fixo */
      }

      .board {
        padding: 10px;
        border-radius: 10px;
      }

      h1 {
        font-size: 18px;
      }

      .card {
        width: 52px;
        height: 78px;
        font-size: 11px;
        padding: 2px;
      }

      .hand {
        gap: 6px;
      }

      .center-area {
        gap: 12px;
      }

      #status {
        font-size: 13px;
        min-height: 32px;
      }

      #top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      #top-bar span {
        font-size: 12px;
      }

      .row {
        justify-content: space-between;
      }

      #cardPreview {
        bottom: 6px;
        padding: 10px 12px;
        max-width: 100%;
        width: calc(100% - 12px);
      }

      #cardPreviewDescription {
        font-size: 12px;
      }

      .card.player-card:hover {
        transform: none;
        box-shadow: 0 4px 0 rgba(0,0,0,0.4);
      }
    }
  </style>
</head>
<body>
  <h1>Imuno-UNO ‚Äì Guerra do Sistema Imune</h1>
  <div id="game">
    <div id="top-bar">
      <span>Jogador (voc√™) üß¨ vs ü§ñ Pat√≥geno Bot</span>
      <button id="newGameBtn">Novo jogo</button>
    </div>

    <div class="board">
      <!-- M√£o do bot -->
      <div>
        <div class="section-title">M√£o do Bot</div>
        <div id="botHand" class="hand"></div>
      </div>

      <hr />

      <!-- Centro: pilha de compra / descarte -->
      <div class="center-area">
        <div>
          <div class="pile-label">Pilha de compra</div>
          <div id="drawPileCard" class="card face-down"></div>
          <div class="small-text" id="deckSizeInfo"></div>
        </div>

        <div>
          <div class="pile-label">√öltima carta jogada</div>
          <div id="discardPileCard" class="card"></div>
          <div class="small-text" id="lastCardInfo"></div>
        </div>
      </div>

      <!-- Status / mensagens -->
      <div id="status"></div>

      <hr />

      <!-- M√£o do jogador -->
      <div>
        <div class="section-title">
          Sua m√£o
          <span class="small-text">(clique em uma carta para ver a explica√ß√£o e decidir jogar)</span>
        </div>
        <div id="playerHand" class="hand"></div>
      </div>

      <!-- Controles do jogador -->
      <div class="row">
        <button id="drawBtn">Comprar carta</button>
        <span class="small-text">
          Turno atual: <span id="turnInfo"></span>
          ‚Ä¢ Situa√ß√£o: <span id="phaseInfo"></span>
        </span>
      </div>
    </div>
  </div>

  <!-- Painel de pr√©-visualiza√ß√£o da carta escolhida -->
  <div id="cardPreview">
    <div id="cardPreviewTitle">Carta selecionada</div>
    <div id="cardPreviewDescription"></div>
    <div class="card-preview-actions">
      <button id="cancelSelectedBtn" class="secondary">Escolher outra carta</button>
      <button id="playSelectedBtn">Jogar carta</button>
    </div>
  </div>

  <script>
    // ------------------------------
    // DEFINI√á√ïES DO BARALHO
    // ------------------------------

    // Cartas do Sistema Imune
    // Cartas do Sistema Imune ‚Äì vers√£o simplificada
const IMMUNE_CARDS = [
  {
    id: "neutrofilo",
    name: "Neutr√≥filo",
    short: "Neutr√≥filo",
    role: "neutrofilo",
    kind: "immune",
    description:
      "Soldado r√°pido da linha de frente. No jogo, ele √© bom para defender contra bact√©rias e alguns fungos."
  },
  {
    id: "macrofago",
    name: "Macr√≥fago",
    short: "Macr√≥fago",
    role: "macrofago",
    kind: "immune",
    description:
      "Lixeiro do corpo: engole invasores e mostra peda√ßos deles para outras c√©lulas. No jogo, ajuda contra bact√©rias, v√≠rus e fungos."
  },
  {
    id: "linfocito_b",
    name: "Linf√≥cito B",
    short: "Linf√≥cito B",
    role: "b",
    kind: "immune",
    description:
      "F√°brica de anticorpos. No jogo, √© usado para defender contra v√≠rus, bact√©rias, vermes e alergias (como se fosse IgE)."
  },
  {
    id: "linfocito_t",
    name: "Linf√≥cito T",
    short: "Linf√≥cito T",
    role: "t",
    kind: "immune",
    description:
      "Comandante e assassino de c√©lulas infectadas. No jogo, √© a defesa principal contra v√≠rus e algumas doen√ßas autoimunes."
  },
  {
    id: "eosinofilo",
    name: "Eosin√≥filo",
    short: "Eosin√≥filo",
    role: "eosinofilo",
    kind: "immune",
    description:
      "Guerreiro com ‚Äúgranadas‚Äù especiais. No jogo, √© muito bom contra vermes (helmintos) e alergias mais fortes."
  },
  {
    id: "mastocito_ige",
    name: "Mast√≥cito + IgE",
    short: "Mast√≥cito + IgE",
    role: "mastocito",
    kind: "immune",
    description:
      "Sentinela das alergias. No jogo, reage r√°pido em alergias (rinite, picada de inseto, alimentos, poeira, p√≥len) e ajuda contra vermes."
  },
  {
    id: "treg",
    name: "Linf√≥cito Treg",
    short: "Treg",
    role: "treg",
    kind: "immune",
    description:
      "Juiz da paz do sistema imune. No jogo, √© a carta que freia exageros, defende contra doen√ßas autoimunes e melhora alergias."
  },
  {
    id: "tecidos_normais",
    name: "Tecidos normais",
    short: "Tecidos",
    role: "tecido_normal",
    kind: "immune",
    description:
      "C√©lulas da pele, f√≠gado, p√¢ncreas, m√∫sculo e neur√¥nios. No jogo, lembram que existem ‚Äúcivis inocentes‚Äù que precisam ser protegidos nas autoimunidades."
  }
];

// Cartas de Doen√ßas ‚Äì vers√£o nova
const DISEASE_CARDS = [
  // 1. V√≠rus gen√©rico
  {
    id: "virus_generico",
    name: "V√≠rus (gen√©rico)",
    short: "V√≠rus",
    category: "viral",
    kind: "disease",
    effectiveRoles: ["t", "b", "macrofago", "neutrofilo"],
    description:
      "Invade por dentro das c√©lulas. No jogo, pode ser defendido por Linf√≥cito T, Linf√≥cito B (anticorpos), Macr√≥fagos e um pouco por Neutr√≥filos."
  },

  // 2. Bact√©ria gen√©rica
  {
    id: "bacteria_generica",
    name: "Bact√©ria (gen√©rica)",
    short: "Bact√©ria",
    category: "bacteriana",
    kind: "disease",
    effectiveRoles: ["neutrofilo", "macrofago", "b"],
    description:
      "Invade o corpo por fora das c√©lulas. No jogo, Neutr√≥filos s√£o a defesa principal, com ajuda de Macr√≥fagos e anticorpos do Linf√≥cito B."
  },

  // 3. Helmintos (vermes)
  {
    id: "helmintos",
    name: "Helmintos (vermes)",
    short: "Helmintos",
    category: "verme",
    kind: "disease",
    effectiveRoles: ["eosinofilo", "mastocito", "b"],
    description:
      "Vermes grand√µes. No jogo, Eosin√≥filos, Mast√≥citos + IgE e Linf√≥citos B (como IgE) s√£o as melhores defesas."
  },

  // 4. Rinite al√©rgica
  {
    id: "rinite_alergica",
    name: "Rinite al√©rgica",
    short: "Rinite",
    category: "alergia",
    kind: "disease",
    effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
    description:
      "Inflama√ß√£o do nariz por alergia. No jogo, Mast√≥citos + IgE, Eosin√≥filos e Linf√≥cito B (IgE) participam. Treg ajuda a controlar o exagero."
  },

  // 5. Alergia a alimentos
  {
    id: "alergia_alimentos",
    name: "Alergia a alimentos",
    short: "Alergia alim.",
    category: "alergia",
    kind: "disease",
    effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
    description:
      "O corpo reage demais a um alimento comum. No jogo, Mast√≥citos + IgE, Eosin√≥filos e Linf√≥citos B (IgE) aparecem. Treg tenta evitar ou diminuir a alergia."
  },

  // 6. Picada de inseto
  {
    id: "picada_inseto",
    name: "Picada de inseto",
    short: "Picada",
    category: "alergia",
    kind: "disease",
    effectiveRoles: ["mastocito", "eosinofilo", "b"],
    description:
      "Rea√ß√£o local com vermelhid√£o e coceira. No jogo, Mast√≥citos + IgE s√£o os primeiros a reagir, com ajuda de Eosin√≥filos e anticorpos do Linf√≥cito B."
  },

  // 7. Febre reum√°tica (autoimune p√≥s-infec√ß√£o)
  {
    id: "febre_reumatica",
    name: "Febre reum√°tica",
    short: "Febre reum.",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Depois de uma infec√ß√£o bacteriana, o corpo confunde o cora√ß√£o com o inimigo. No jogo, s√≥ Treg √© considerado uma defesa eficaz, porque ajuda a frear o ataque errado."
  },

  // 8. P√≥len
  {
    id: "polen",
    name: "P√≥len",
    short: "P√≥len",
    category: "alergia",
    kind: "disease",
    effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
    description:
      "Gr√£ozinho de planta que causa alergia em algumas pessoas. No jogo, Mast√≥citos + IgE, Eosin√≥filos e Linf√≥citos B (IgE) reagem, e Treg ajuda a acalmar."
  },

  // 9. Poeira
  {
    id: "poeira",
    name: "Poeira",
    short: "Poeira",
    category: "alergia",
    kind: "disease",
    effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
    description:
      "Poeira de casa pode ser um gatilho de alergia. No jogo, Mast√≥citos + IgE, Eosin√≥filos e Linf√≥citos B (IgE) atuam, com Treg como freio."
  },

  // 10. Falta de Treg
  {
    id: "falta_treg",
    name: "Falta de Treg",
    short: "Falta Treg",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Quando quase n√£o h√° ‚Äújuiz da paz‚Äù. No jogo, isso simboliza perda do freio: autoimunes e alergias ficam piores. Jogar Treg aqui representa recuperar o controle."
  },

  // 11. Artrite reumatoide
  {
    id: "artrite_reumatoide",
    name: "Artrite reumatoide",
    short: "AR",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Autoimune nas articula√ß√µes. No jogo, s√≥ Treg √© tratado como defesa eficaz, pois representa frear a inflama√ß√£o exagerada contra as juntas."
  },

  // 12. Diabetes Mellitus tipo 1 (DM1)
  {
    id: "dm1",
    name: "Diabetes Mellitus tipo 1",
    short: "DM1",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Autoimune contra as c√©lulas do p√¢ncreas que produzem insulina. No jogo, Treg √© a √∫nica carta que ‚Äútenta parar‚Äù esse ataque."
  },

  // 13. Autoanticorpos
  {
    id: "autoanticorpos",
    name: "Autoanticorpos",
    short: "Autoantic.",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Anticorpos que atacam o pr√≥prio corpo. No jogo, representam o erro do sistema imune em doen√ßas como l√∫pus, artrite reumatoide e outras. Treg √© a carta que tenta corrigir o exagero."
  },

  // 14. L√∫pus
  {
    id: "lupus",
    name: "L√∫pus eritematoso sist√™mico",
    short: "L√∫pus",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Doen√ßa autoimune que pode pegar v√°rios √≥rg√£os ao mesmo tempo. No jogo, Treg √© a defesa porque simboliza o freio para tantos ataques errados."
  },

  // 15. Doen√ßa cel√≠aca
  {
    id: "doenca_celiaca",
    name: "Doen√ßa cel√≠aca",
    short: "Cel√≠aca",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Autoimune que aparece quando o corpo reage ao gl√∫ten e machuca o intestino. No jogo, Treg √© a carta que representa controlar esse ataque √†s mucosas."
  },

  // 16. Hashimoto
  {
    id: "hashimoto",
    name: "Tireoidite de Hashimoto",
    short: "Hashimoto",
    category: "autoimune",
    kind: "disease",
    effectiveRoles: ["treg"],
    description:
      "Autoimune da tireoide. No jogo, Treg √© a defesa principal, mostrando que o freio evita que o corpo destrua a pr√≥pria gl√¢ndula."
  }
];


    // ------------------------------
    // ESTADO DO JOGO
    // ------------------------------
    let deck = [];
    let discardPile = [];
    let players = [];
    let currentPlayer = 0; // 0 = voc√™, 1 = bot
    let gameOver = false;
    let selectedCardIndex = null;

    // Ataque pendente: doen√ßa lan√ßada que algu√©m precisa defender
    // { targetIndex: 0 ou 1, diseaseCard: {...} }
    let pendingAttack = null;

    // ------------------------------
    // UTILIT√ÅRIAS
    // ------------------------------
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createDeck() {
      const newDeck = [];

      // V√°rias c√≥pias das c√©lulas
      IMMUNE_CARDS.forEach(cardDef => {
        for (let i = 0; i < 4; i++) {
          newDeck.push({ ...cardDef });
        }
      });

      // Algumas c√≥pias das doen√ßas
      DISEASE_CARDS.forEach(cardDef => {
        for (let i = 0; i < 2; i++) {
          newDeck.push({ ...cardDef });
        }
      });

      return shuffle(newDeck);
    }

    function drawCardFromDeck() {
      if (deck.length === 0) {
        if (discardPile.length > 1) {
          const top = discardPile.pop();
          deck = shuffle(discardPile);
          discardPile = [top];
        } else {
          return null;
        }
      }
      return deck.pop();
    }

    function isImmuneCard(card) {
      return card && card.kind === "immune";
    }

    function isDiseaseCard(card) {
      return card && card.kind === "disease";
    }

    function isEffectiveDefense(immuneCard, diseaseCard) {
      if (!immuneCard || !diseaseCard) return false;
      if (!isImmuneCard(immuneCard) || !isDiseaseCard(diseaseCard)) return false;
      return diseaseCard.effectiveRoles.includes(immuneCard.role);
    }

    function cardCssClass(card) {
      if (!card) return "card";
      if (isImmuneCard(card)) return "card immune";
      // Doen√ßas por categoria
      switch (card.category) {
        case "autoimune":  return "card disease-autoimune";
        case "viral":      return "card disease-viral";
        case "bacteriana": return "card disease-bacteriana";
        case "verme":      return "card disease-verme";
        case "fungo":      return "card disease-fungo";
        case "alergia":    return "card disease-alergia";
        default:           return "card";
      }
    }

    function describeCategory(card) {
      if (!card || !isDiseaseCard(card)) return "";
      switch (card.category) {
        case "autoimune":  return "Doen√ßa autoimune";
        case "viral":      return "Doen√ßa viral";
        case "bacteriana": return "Doen√ßa bacteriana";
        case "verme":      return "Infec√ß√£o por verme (helminto)";
        case "fungo":      return "Infec√ß√£o f√∫ngica";
        case "alergia":    return "Doen√ßa al√©rgica";
        default:           return "";
      }
    }

    // Efeito especial: Th1/Th2/Th17 descartam outras c√©lulas
    function applyThMassDiscard(playerIndex, card) {
      if (!card || !isImmuneCard(card)) return;
      const player = players[playerIndex];
      if (!player) return;

      let roleToDiscard = null;
      if (card.role === "th1") {
        roleToDiscard = "macrofago";
      } else if (card.role === "th2") {
        roleToDiscard = "eosinofilo";
      } else if (card.role === "th17") {
        roleToDiscard = "neutrofilo";
      }

      if (!roleToDiscard) return;

      const remaining = [];
      player.hand.forEach(c => {
        if (c.role === roleToDiscard) {
          discardPile.push(c);
        } else {
          remaining.push(c);
        }
      });
      player.hand = remaining;
    }

    // ------------------------------
    // CONTROLE DE JOGO
    // ------------------------------
    function dealInitialHands() {
      players = [
        { name: "Voc√™", hand: [] },
        { name: "Bot", hand: [] }
      ];

      const initialCards = 7;
      for (let i = 0; i < initialCards; i++) {
        players[0].hand.push(drawCardFromDeck());
        players[1].hand.push(drawCardFromDeck());
      }

      // Primeira carta de descarte: preferir c√©lula (para n√£o come√ßar com doen√ßa atacando)
      let firstCard = drawCardFromDeck();
      let tries = 0;
      while (firstCard && isDiseaseCard(firstCard) && tries < 20) {
        deck.unshift(firstCard);
        firstCard = drawCardFromDeck();
        tries++;
      }

      if (firstCard) {
        discardPile = [firstCard];
      } else {
        discardPile = [];
      }

      pendingAttack = null;
    }

    function startGame() {
      deck = createDeck();
      discardPile = [];
      gameOver = false;
      currentPlayer = 0;
      selectedCardIndex = null;
      pendingAttack = null;
      hideCardPreview();

      dealInitialHands();
      updateStatus("O jogo come√ßou. Seu objetivo √© ficar sem cartas na m√£o.");
      render();

      if (currentPlayer === 1 && !gameOver) {
        setTimeout(botTurn, 600);
      }
    }

    function checkWin(playerIndex) {
      if (players[playerIndex].hand.length === 0) {
        gameOver = true;
        if (playerIndex === 0) {
          updateStatus("Voc√™ ficou sem cartas na m√£o. Vit√≥ria do sistema imune humano!");
        } else {
          updateStatus("O bot ficou sem cartas. O pat√≥geno venceu desta vez.");
        }
      }
    }

    function endTurn() {
      if (gameOver) return;
      currentPlayer = (currentPlayer + 1) % players.length;
      selectedCardIndex = null;
      hideCardPreview();
      render();

      if (currentPlayer === 1 && !gameOver) {
        setTimeout(botTurn, 700);
      } else if (!gameOver) {
        if (pendingAttack && pendingAttack.targetIndex === 0) {
          updateStatus(
            "Voc√™ est√° sob ataque de " + pendingAttack.diseaseCard.name +
            ". Jogue uma carta de defesa √∫til ou compre 1 carta."
          );
        } else {
          updateStatus("Seu turno.");
        }
      }
    }

    // ------------------------------
    // A√á√ïES DO JOGADOR
    // ------------------------------
    function canPlayCardForCurrentState(card) {
      if (gameOver || currentPlayer !== 0) return false;
      if (!card) return false;

      if (pendingAttack && pendingAttack.targetIndex === 0) {
        // Sob ataque: s√≥ pode jogar cartas do sistema imune para tentar defender
        return isImmuneCard(card);
      }
      // Sem ataque: pode jogar qualquer carta
      return true;
    }

    function handlePlayerCardClick(index) {
      if (gameOver || currentPlayer !== 0) return;
      const player = players[0];
      const card = player.hand[index];
      selectedCardIndex = index;
      showCardPreview(card);
      renderPlayerHand();
    }

    function playerPlaySelectedCard() {
      if (selectedCardIndex === null) return;
      const player = players[0];
      const card = player.hand[selectedCardIndex];
      if (!canPlayCardForCurrentState(card)) {
        updateStatus("Esta carta n√£o pode ser jogada neste momento.");
        return;
      }
      playCard(0, selectedCardIndex);
    }

    function playerDrawCard() {
      if (gameOver || currentPlayer !== 0) return;
      const player = players[0];

      if (pendingAttack && pendingAttack.targetIndex === 0) {
        // Jogador decide n√£o se defender: toma o dano da doen√ßa
        const newCard = drawCardFromDeck();
        if (newCard) {
          player.hand.push(newCard);
          updateStatus(
            "Voc√™ n√£o se defendeu de " + pendingAttack.diseaseCard.name +
            " e comprou 1 carta."
          );
        } else {
          updateStatus("N√£o h√° mais cartas para comprar.");
        }
        pendingAttack = null;
        render();
        endTurn();
        return;
      }

      // Situa√ß√£o normal: apenas compra e passa o turno
      const newCard = drawCardFromDeck();
      if (newCard) {
        player.hand.push(newCard);
        updateStatus("Voc√™ comprou 1 carta e passou o turno.");
      } else {
        updateStatus("N√£o h√° mais cartas para comprar.");
      }
      render();
      endTurn();
    }

    // ------------------------------
    // L√ìGICA DE JOGAR CARTA (comum a jogador e bot)
    // ------------------------------
    function playCard(playerIndex, cardIndex, sourceElementForAnimation) {
      if (gameOver) return;
      const player = players[playerIndex];
      const card = player.hand[cardIndex];
      if (!card) return;

      // Anima√ß√£o
      if (sourceElementForAnimation) {
        animateCardToDiscard(sourceElementForAnimation, card);
      }

      // Remove da m√£o
      player.hand.splice(cardIndex, 1);
      discardPile.push(card);

      // Efeito especial de Th1 / Th2 / Th17 (descarta macr√≥fagos / eosin√≥filos / neutr√≥filos)
      applyThMassDiscard(playerIndex, card);

      // Se o jogador est√° sob ataque, isso √© uma tentativa de defesa
      if (pendingAttack && pendingAttack.targetIndex === playerIndex) {
        resolveDefense(playerIndex, card);
        return;
      }

      // Caso geral: ningu√©m estava sob ataque, √© um ataque novo ou s√≥ descarte
      if (isDiseaseCard(card)) {
        // Doen√ßa atacando o outro jogador
        const target = (playerIndex + 1) % players.length;
        pendingAttack = {
          targetIndex: target,
          diseaseCard: card
        };
        updateStatus(
          player.name + " lan√ßou a doen√ßa " + card.name +
          " contra " + players[target].name + "."
        );
      } else {
        // C√©lula jogada fora de contexto de defesa: apenas descarte l√∫dico
        updateStatus(player.name + " jogou a c√©lula " + card.name + ".");
      }

      checkWin(playerIndex);
      render();
      if (!gameOver) {
        endTurn();
      }
    }

    // Resolve quando algu√©m joga carta durante ataque
    function resolveDefense(playerIndex, immuneCard) {
      const attack = pendingAttack;
      pendingAttack = null; // ataque vai ser resolvido agora

      const opponentIndex = (playerIndex + 1) % players.length;
      const defender = players[playerIndex];
      const opponent = players[opponentIndex];

      if (!isImmuneCard(immuneCard)) {
        // Jogou algo que n√£o √© c√©lula (na pr√°tica n√£o deve acontecer, mas fica por seguran√ßa)
        const newCard = drawCardFromDeck();
        if (newCard) defender.hand.push(newCard);
        updateStatus(
          defender.name +
          " tentou se defender com uma carta inv√°lida e comprou 1 carta."
        );
        render();
        endTurn();
        return;
      }

      const effective = isEffectiveDefense(immuneCard, attack.diseaseCard);

      if (effective) {
        // Primeiro verifica se o defensor j√° ganhou ao jogar a carta
        checkWin(playerIndex);
        if (gameOver) {
          render();
          return;
        }

        // Ataque foi revertido: o oponente compra 1 carta
        const newCard = drawCardFromDeck();
        if (newCard) opponent.hand.push(newCard);
        updateStatus(
          defender.name +
          " se defendeu com " + immuneCard.name +
          " contra " + attack.diseaseCard.name +
          ". O atacante (" + opponent.name + ") comprou 1 carta."
        );
      } else {
        // Defesa falhou: o defensor compra 1 carta
        const newCard = drawCardFromDeck();
        if (newCard) defender.hand.push(newCard);
        updateStatus(
          defender.name +
          " tentou se defender com " + immuneCard.name +
          " contra " + attack.diseaseCard.name +
          ", mas n√£o foi eficaz. " +
          defender.name + " comprou 1 carta."
        );
      }

      render();
      if (!gameOver) {
        endTurn();
      }
    }

    // ------------------------------
    // TURNO DO BOT
    // ------------------------------
    function botTurn() {
      if (gameOver || currentPlayer !== 1) return;
      const bot = players[1];

      // Se o bot est√° sob ataque, tenta se defender
      if (pendingAttack && pendingAttack.targetIndex === 1) {
        const disease = pendingAttack.diseaseCard;

        // 1¬∫ tenta achar uma carta eficaz
        let effectiveIndex = -1;
        for (let i = 0; i < bot.hand.length; i++) {
          const card = bot.hand[i];
          if (isImmuneCard(card) && isEffectiveDefense(card, disease)) {
            effectiveIndex = i;
            break;
          }
        }

        if (effectiveIndex !== -1) {
          const cardEl = botHandEl.children[effectiveIndex];
          playCard(1, effectiveIndex, cardEl);
          return;
        }

        // 2¬∫ se n√£o tem eficaz, tenta qualquer c√©lula
        let anyImmuneIndex = -1;
        for (let i = 0; i < bot.hand.length; i++) {
          const card = bot.hand[i];
          if (isImmuneCard(card)) {
            anyImmuneIndex = i;
            break;
          }
        }

        if (anyImmuneIndex !== -1) {
          const cardEl = botHandEl.children[anyImmuneIndex];
          playCard(1, anyImmuneIndex, cardEl);
          return;
        }

        // 3¬∫ n√£o tem defesa: compra 1 carta e encerra o ataque
        const newCard = drawCardFromDeck();
        if (newCard) bot.hand.push(newCard);
        updateStatus(
          "Bot n√£o conseguiu se defender de " + disease.name +
          " e comprou 1 carta."
        );
        pendingAttack = null;
        render();
        endTurn();
        return;
      }

      // Se n√£o est√° sob ataque: decide ataque
      // Prioridade: jogar doen√ßa
      let diseaseIndex = -1;
      for (let i = 0; i < bot.hand.length; i++) {
        if (isDiseaseCard(bot.hand[i])) {
          diseaseIndex = i;
          break;
        }
      }

      if (diseaseIndex !== -1) {
        const cardEl = botHandEl.children[diseaseIndex];
        playCard(1, diseaseIndex, cardEl);
        return;
      }

      // Se n√£o tem doen√ßa, joga qualquer c√©lula (tenta usar Th primeiro para descartar mais)
      let thIndex = -1;
      let anyImmuneIndex = -1;
      for (let i = 0; i < bot.hand.length; i++) {
        const card = bot.hand[i];
        if (isImmuneCard(card)) {
          if ((card.role === "th1" || card.role === "th2" || card.role === "th17") && thIndex === -1) {
            thIndex = i;
          }
          if (anyImmuneIndex === -1) anyImmuneIndex = i;
        }
      }

      if (thIndex !== -1) {
        const cardEl = botHandEl.children[thIndex];
        playCard(1, thIndex, cardEl);
        return;
      }

      if (anyImmuneIndex !== -1) {
        const cardEl = botHandEl.children[anyImmuneIndex];
        playCard(1, anyImmuneIndex, cardEl);
        return;
      }

      // Se n√£o tem nada para jogar, compra 1 carta
      const newCard = drawCardFromDeck();
      if (newCard) {
        bot.hand.push(newCard);
        updateStatus("Bot comprou 1 carta e passou o turno.");
      } else {
        updateStatus("Bot tentou comprar carta, mas n√£o havia mais no baralho.");
      }
      render();
      endTurn();
    }

    // ------------------------------
    // INTERFACE / DOM
    // ------------------------------
    const playerHandEl = document.getElementById("playerHand");
    const botHandEl = document.getElementById("botHand");
    const discardPileCardEl = document.getElementById("discardPileCard");
    const drawPileCardEl = document.getElementById("drawPileCard");
    const statusEl = document.getElementById("status");
    const deckSizeInfoEl = document.getElementById("deckSizeInfo");
    const turnInfoEl = document.getElementById("turnInfo");
    const phaseInfoEl = document.getElementById("phaseInfo");
    const drawBtnEl = document.getElementById("drawBtn");
    const newGameBtnEl = document.getElementById("newGameBtn");
    const lastCardInfoEl = document.getElementById("lastCardInfo");

    const cardPreviewEl = document.getElementById("cardPreview");
    const cardPreviewDescriptionEl = document.getElementById("cardPreviewDescription");
    const cardPreviewTitleEl = document.getElementById("cardPreviewTitle");
    const playSelectedBtn = document.getElementById("playSelectedBtn");
    const cancelSelectedBtn = document.getElementById("cancelSelectedBtn");

    function updateStatus(text) {
      statusEl.textContent = text;
    }

    function render() {
      renderPlayerHand();
      renderBotHand();

      const top = discardPile[discardPile.length - 1];
      if (top) {
        discardPileCardEl.className = cardCssClass(top);
        discardPileCardEl.textContent = top.short || top.name;
        if (isDiseaseCard(top)) {
          lastCardInfoEl.textContent = describeCategory(top);
        } else {
          lastCardInfoEl.textContent = "C√©lula imune jogada.";
        }
      } else {
        discardPileCardEl.className = "card";
        discardPileCardEl.textContent = "";
        lastCardInfoEl.textContent = "";
      }

      drawPileCardEl.className = "card face-down";
      deckSizeInfoEl.textContent = `Cartas restantes: ${deck.length}`;
      turnInfoEl.textContent = players[currentPlayer]?.name || "";

      if (pendingAttack) {
        const targetName = players[pendingAttack.targetIndex].name;
        const diseaseName = pendingAttack.diseaseCard.name;
        phaseInfoEl.textContent = `Ataque: ${diseaseName} em ${targetName}`;
      } else {
        phaseInfoEl.textContent = "Sem ataque ativo";
      }

      drawBtnEl.disabled = gameOver || currentPlayer !== 0;
    }

    function renderPlayerHand() {
      playerHandEl.innerHTML = "";
      const player = players[0];
      if (!player) return;

      player.hand.forEach((card, index) => {
        const cardDiv = document.createElement("div");
        let cls = cardCssClass(card) + " player-card";
        if (index === selectedCardIndex) {
          cls += " selected";
        }
        cardDiv.className = cls;
        cardDiv.textContent = card.short || card.name;
        cardDiv.title = "Clique para saber mais e decidir jogar";
        cardDiv.addEventListener("click", () => handlePlayerCardClick(index));
        playerHandEl.appendChild(cardDiv);
      });
    }

    function renderBotHand() {
      botHandEl.innerHTML = "";
      const bot = players[1];
      if (!bot) return;

      bot.hand.forEach(() => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card face-down";
        botHandEl.appendChild(cardDiv);
      });
    }

    // Anima√ß√£o de carta voando
    function animateCardToDiscard(fromElement, card) {
      if (!fromElement || !discardPileCardEl) return;

      const fromRect = fromElement.getBoundingClientRect();
      const toRect = discardPileCardEl.getBoundingClientRect();

      const flying = document.createElement("div");
      flying.className = cardCssClass(card) + " flying-card";
      flying.textContent = card.short || card.name;
      flying.style.left = fromRect.left + "px";
      flying.style.top = fromRect.top + "px";

      document.body.appendChild(flying);

      const dx = toRect.left - fromRect.left;
      const dy = toRect.top - fromRect.top;

      requestAnimationFrame(() => {
        flying.style.transform = `translate(${dx}px, ${dy}px) scale(0.9)`;
        flying.style.opacity = "0.1";
      });

      flying.addEventListener("transitionend", () => {
        flying.remove();
      });
    }

    // ------------------------------
    // PR√â-VISUALIZA√á√ÉO DA CARTA
    // ------------------------------
    function showCardPreview(card) {
      if (!card) return;

      cardPreviewTitleEl.textContent = card.name;

      let baseInfo = "";

      if (isImmuneCard(card)) {
        baseInfo += `<strong>Tipo:</strong> C√©lula do sistema imune<br/>`;
        baseInfo += `<strong>Fun√ß√£o l√∫dica:</strong> ${card.description}<br/>`;

        if (card.role === "th1") {
          baseInfo += `<strong>Efeito especial:</strong> ao jogar Th1 fora de defesa, voc√™ descarta todos os seus Macr√≥fagos junto com ele.<br/>`;
        } else if (card.role === "th2") {
          baseInfo += `<strong>Efeito especial:</strong> ao jogar Th2 fora de defesa, voc√™ descarta todos os seus Eosin√≥filos junto com ele.<br/>`;
        } else if (card.role === "th17") {
          baseInfo += `<strong>Efeito especial:</strong> ao jogar Th17 fora de defesa, voc√™ descarta todos os seus Neutr√≥filos junto com ele.<br/>`;
        }
      } else if (isDiseaseCard(card)) {
        baseInfo += `<strong>Tipo:</strong> ${describeCategory(card)}<br/>`;
        baseInfo += `<strong>Descri√ß√£o l√∫dica:</strong> ${card.description}<br/>`;
        baseInfo += `<br/><strong>Defesas eficazes:</strong> `;
        const roles = card.effectiveRoles.map(r => {
          const def = IMMUNE_CARDS.find(c => c.role === r);
          return def ? def.name : r;
        });
        baseInfo += roles.join(", ") + ".<br/>";
        baseInfo += `<br/>Se voc√™ jogar esta carta em algu√©m, ele ficar√° sob ataque e ter√° que se defender com uma dessas c√©lulas ou comprar 1 carta.`;
      }

      // Se existe ataque ativo e voc√™ √© o alvo, explicar se esta carta ajuda
      if (pendingAttack && pendingAttack.targetIndex === 0 && isImmuneCard(card)) {
        const disease = pendingAttack.diseaseCard;
        const effective = isEffectiveDefense(card, disease);
        baseInfo += `<hr/>`;
        baseInfo += `<strong>Situa√ß√£o atual:</strong> Voc√™ est√° sob ataque de <em>${disease.name}</em>.<br/>`;
        if (effective) {
          baseInfo += `<strong>Resultado se jogar esta carta agora:</strong> defesa BEM-SUCEDIDA. O oponente comprar√° 1 carta e o ataque acaba.<br/>`;
        } else {
          baseInfo += `<strong>Resultado se jogar esta carta agora:</strong> defesa FALHOU. Voc√™ ter√° que comprar 1 carta mesmo assim e o ataque acaba.<br/>`;
        }
      }

      cardPreviewDescriptionEl.innerHTML = baseInfo;

      const canPlay = canPlayCardForCurrentState(card);
      playSelectedBtn.disabled = !canPlay;

      cardPreviewEl.classList.add("visible");
    }

    function hideCardPreview() {
      cardPreviewEl.classList.remove("visible");
    }

    // ------------------------------
    // EVENTOS
    // ------------------------------
    drawBtnEl.addEventListener("click", playerDrawCard);
    newGameBtnEl.addEventListener("click", startGame);
    playSelectedBtn.addEventListener("click", playerPlaySelectedCard);
    cancelSelectedBtn.addEventListener("click", () => {
      selectedCardIndex = null;
      hideCardPreview();
      renderPlayerHand();
    });

    // Inicia o jogo ao carregar
    startGame();
  </script>
</body>
</html>
