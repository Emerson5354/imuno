<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- Focado em celular -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ImUNO ‚Äì Guerra do Sistema Imune</title>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --bg-elevated: #020617;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --accent: #f97316;
      --accent-dark: #ea580c;
      --danger: #b91c1c;
      --card-radius: 12px;
      --shadow-strong: 0 18px 40px rgba(0,0,0,0.7);
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.5);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 35%, #020617 100%);
      color: var(--fg);
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      display: flex;
    }

    .screen {
      flex: 1;
      display: none;
      flex-direction: column;
    }

    .screen.active {
      display: flex;
    }

    /* ========= TELA INICIAL (APP-LIKE) ========= */

    #screen-start {
      padding: 32px 18px;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 24px;
    }

    .logo-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .start-title {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin: 0;
    }

    .start-subtitle {
      margin: 6px 0 0 0;
      font-size: 14px;
      color: var(--muted);
    }

    .start-card {
      margin-top: 18px;
      padding: 20px 18px;
      border-radius: 20px;
      background: radial-gradient(circle at top left, rgba(248,250,252,0.06), rgba(15,23,42,0.98));
      box-shadow: var(--shadow-strong);
      border: 1px solid rgba(15,23,42,0.9);
      width: 100%;
      max-width: 420px;
      text-align: left;
    }

    .start-card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .start-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      margin: 0 0 6px 0;
    }

    .start-card-text strong {
      color: var(--fg);
      font-weight: 600;
    }

    .start-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 18px;
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-soft);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #0b1120;
      box-shadow: 0 10px 24px rgba(248,113,113,0.4);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(248,113,113,0.5);
    }

    .btn-ghost {
      background: rgba(15,23,42,0.95);
      color: var(--fg);
      border: 1px solid rgba(51,65,85,0.9);
      box-shadow: 0 8px 20px rgba(15,23,42,0.9);
    }

    .btn-ghost:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.9);
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 12px;
      box-shadow: none;
    }

    .start-footer {
      margin-top: 16px;
      font-size: 11px;
      color: var(--muted);
    }

    /* ========= TELA DO JOGO ========= */

    #screen-game {
      padding: 10px 10px 12px 10px;
      gap: 8px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 2px 4px 2px;
    }

    .game-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .game-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .game-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .top-bar-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      font-size: 11px;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(51,65,85,0.9);
      background: rgba(15,23,42,0.95);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .pill-danger .pill-dot {
      background: var(--danger);
    }

    .game-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .row-compact {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      padding: 0 2px;
    }

    .player-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      font-size: 11px;
    }

    .player-icon {
      font-size: 14px;
    }

    .table-area {
      flex: 1;
      margin-top: 4px;
      padding: 12px;
      border-radius: 20px;
      background: radial-gradient(circle at top, rgba(148,163,184,0.08), rgba(15,23,42,0.98));
      box-shadow: var(--shadow-strong);
      display: flex;
      align-items: center;
      justify-content: space-evenly;
      gap: 12px;
    }

    .stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 120px;
    }

    .stack-label {
      font-size: 11px;
      color: var(--muted);
    }

    .stack-meta {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      min-height: 26px;
    }

    .stack-card {
      transform: translateY(0);
    }

    /* ========= CARTAS ========= */

    .hand-panel {
      border-top: 1px solid rgba(15,23,42,0.9);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-line {
      min-height: 30px;
      font-size: 12px;
      color: var(--muted);
      padding: 0 2px;
    }

    .hand-scroll {
      overflow-x: auto;
      overflow-y: visible;
      padding-bottom: 6px;
    }

    .hand {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      padding: 2px 2px 6px 2px;
    }

    .card {
      position: relative;
      flex: 0 0 76px;
      height: 110px;
      border-radius: var(--card-radius);
      border: 1px solid rgba(15,23,42,0.95);
      background: #111827;
      color: #f9fafb;
      padding: 4px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    .card.player-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.95);
      filter: brightness(1.04);
    }

    .card-top {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      opacity: 0.95;
    }

    .card-type {
      font-weight: 600;
    }

    .card-name {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      padding: 0 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-footer {
      font-size: 9px;
      opacity: 0.9;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card.selected {
      outline: 2px solid #f9fafb;
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 14px 28px rgba(15,23,42,1);
    }

    .card.face-down {
      background: linear-gradient(135deg, #020617, #111827);
      color: transparent;
      cursor: default;
    }

    .card.face-down::before {
      content: "üß¨";
      color: #e5e7eb;
      font-size: 26px;
      width: 100%;
      text-align: center;
      margin-top: 24px;
    }

    /* Cores l√∫dicas das cartas */

    .card.immune {
      background: radial-gradient(circle at top left, #16a34a, #065f46);
    }

    .card.disease-autoimune {
      background: radial-gradient(circle at top left, #b91c1c, #7f1d1d);
    }

    .card.disease-viral {
      background: radial-gradient(circle at top left, #2563eb, #1d4ed8);
    }

    .card.disease-bacteriana {
      background: radial-gradient(circle at top left, #d97706, #92400e);
    }

    .card.disease-verme {
      background: radial-gradient(circle at top left, #4b5563, #111827);
    }

    .card.disease-fungo {
      background: radial-gradient(circle at top left, #7c3aed, #4c1d95);
    }

    .card.disease-alergia {
      background: radial-gradient(circle at top left, #f97316, #b91c1c);
    }

    /* Controles inferiores */

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 0 2px 2px 2px;
    }

    .controls-right {
      display: flex;
      gap: 4px;
    }

    .btn[disabled] {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    /* Oculta visualmente a m√£o do bot (usada s√≥ como estrutura l√≥gica) */

    #botHand {
      display: none;
    }

    /* ========= PR√â-VISUALIZA√á√ÉO DA CARTA ========= */

    #cardPreview {
      position: fixed;
      left: 50%;
      bottom: 8px;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.98);
      border-radius: 14px;
      padding: 10px 12px;
      max-width: 480px;
      width: calc(100% - 14px);
      box-shadow: var(--shadow-strong);
      border: 1px solid rgba(31,41,55,0.95);
      display: none;
      z-index: 999;
      backdrop-filter: blur(8px);
    }

    #cardPreview.visible {
      display: block;
      animation: slide-up 0.16s ease-out;
    }

    #cardPreviewTitle {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    #cardPreviewDescription {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      max-height: 40vh;
      overflow-y: auto;
      line-height: 1.45;
    }

    .card-preview-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn-secondary {
      background: #020617;
      color: var(--fg);
      border: 1px solid rgba(51,65,85,0.9);
      box-shadow: none;
    }

    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translate(-50%, 10px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    /* ========= TUTORIAL / AJUDA ========= */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .overlay.hidden {
      display: none;
    }

    .overlay-box {
      background: #020617;
      border-radius: 18px;
      padding: 14px 16px;
      max-width: 480px;
      width: calc(100% - 24px);
      box-shadow: var(--shadow-strong);
      border: 1px solid rgba(31,41,55,0.95);
      font-size: 13px;
      color: var(--fg);
    }

    .overlay-box h2 {
      margin: 0 0 6px 0;
      font-size: 16px;
    }

    .overlay-box p {
      margin: 4px 0;
      line-height: 1.5;
      color: var(--muted);
    }

    .overlay-box ul {
      margin: 4px 0 6px 18px;
      padding: 0;
      color: var(--muted);
    }

    .overlay-box li {
      margin-bottom: 4px;
    }

    .overlay-step-info {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .overlay-buttons {
      display: flex;
      justify-content: flex-end;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    /* ========= NOTIFICA√á√ÉO CENTRAL ========= */

    #notification {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      transition: opacity 0.16s ease-out;
      pointer-events: none;
    }

    #notification.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #notificationContent {
      max-width: 480px;
      width: calc(100% - 40px);
      background: var(--danger);
      color: #fee2e2;
      padding: 12px 18px;
      border-radius: 16px;
      border: 2px solid #7f1d1d;
      box-shadow: var(--shadow-strong);
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      transform: translateY(8px);
      transition: transform 0.16s ease-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    #notification.visible #notificationContent {
      transform: translateY(0);
    }

    #notificationText {
      width: 100%;
    }

    /* ========= RESPONSIVO PEQUENO ========= */

    @media (max-width: 420px) {
      #screen-start {
        padding: 26px 14px;
      }
      .start-title {
        font-size: 24px;
      }
      .start-card {
        padding: 16px 14px;
      }
      .card {
        flex: 0 0 68px;
        height: 100px;
        font-size: 11px;
      }
      .card-name {
        font-size: 10px;
      }
      #cardPreviewDescription {
        font-size: 11px;
      }
      #notificationContent {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- TELA INICIAL ‚Äì APP-LIKE -->
    <div id="screen-start" class="screen active">
      <div>
        <div class="logo-pill">Jogo de cartas imunol√≥gico</div>
        <h1 class="start-title">ImUNO</h1>
        <p class="start-subtitle">Guerra do Sistema Imune contra o Pat√≥geno Bot</p>

        <div class="start-card">
          <div class="start-card-title">Como funciona:</div>
          <p class="start-card-text">
            Voc√™ controla o <strong>sistema imune</strong> üß¨ e o bot representa um <strong>pat√≥geno</strong> ü§ñ.
          </p>
          <p class="start-card-text">
            Use cartas de <strong>doen√ßas</strong> (‚öî) para atacar e cartas de <strong>c√©lulas de defesa</strong> (üõ°) para se proteger.
          </p>
          <p class="start-card-text">
            <strong>Objetivo:</strong> ficar sem cartas na m√£o antes do bot.
          </p>

          <div class="start-actions">
            <button id="startPlayBtn" class="btn btn-primary">
              üéÆ Jogar agora
            </button>
            <button id="startHowBtn" class="btn btn-ghost">
              ‚ùì Ver como jogar
            </button>
          </div>
        </div>

        <div class="start-footer">
          Pensado para uso em celular ‚Äì tudo com toque, deslize e leitura simples.
        </div>
      </div>
    </div>

    <!-- TELA DO JOGO -->
    <div id="screen-game" class="screen">
      <header class="top-bar">
        <div class="game-title-wrap">
          <div class="game-title">ImUNO</div>
          <div class="game-sub">Sistema imune vs pat√≥geno</div>
        </div>
        <div class="top-bar-right">
          <div class="pill">
            <span class="pill-dot"></span>
            <span>Turno: <span id="turnInfo">-</span></span>
          </div>
          <div class="pill pill-danger">
            <span class="pill-dot"></span>
            <span id="phaseInfo">Sem ataque ativo</span>
          </div>
        </div>
      </header>

      <main class="game-main">
        <div class="row-compact">
          <div class="player-chip">
            <span class="player-icon">ü§ñ</span>
            <span>Bot ¬∑ <span id="botCardCount">0</span> cartas</span>
          </div>
          <div class="player-chip">
            <span class="player-icon">üß¨</span>
            <span>Voc√™ ¬∑ <span id="playerCardCount">0</span> cartas</span>
          </div>
        </div>

        <section class="table-area">
          <div class="stack">
            <div class="stack-label">Pilha de compra</div>
            <div id="drawPileCard" class="card stack-card face-down"></div>
            <div id="deckSizeInfo" class="stack-meta"></div>
          </div>
          <div class="stack">
            <div class="stack-label">√öltima carta jogada</div>
            <div id="discardPileCard" class="card stack-card"></div>
            <div id="lastCardInfo" class="stack-meta"></div>
          </div>
        </section>
      </main>

      <footer class="hand-panel">
        <div id="status" class="status-line"></div>
        <div class="hand-scroll">
          <div id="playerHand" class="hand"></div>
        </div>
        <div class="controls">
          <button id="drawBtn" class="btn btn-primary">Comprar carta</button>
          <div class="controls-right">
            <button id="helpBtn" class="btn btn-secondary btn-sm">Ajuda</button>
            <button id="newGameBtn" class="btn btn-secondary btn-sm">Reiniciar</button>
          </div>
        </div>
      </footer>

      <!-- Container l√≥gico da m√£o do bot (n√£o aparece na tela) -->
      <div id="botHand"></div>
    </div>
  </div>

  <!-- PR√â-VISUALIZA√á√ÉO DA CARTA -->
  <div id="cardPreview">
    <div id="cardPreviewTitle">Carta selecionada</div>
    <div id="cardPreviewDescription"></div>
    <div class="card-preview-actions">
      <button id="cancelSelectedBtn" class="btn btn-secondary btn-sm">Escolher outra</button>
      <button id="playSelectedBtn" class="btn btn-primary btn-sm">Jogar carta</button>
    </div>
  </div>

  <!-- TUTORIAL / AJUDA -->
  <div id="tutorialOverlay" class="overlay hidden">
    <div class="overlay-box">
      <h2 id="tutorialTitle">Bem-vindo ao ImUNO</h2>
      <p id="tutorialBody">Carregando...</p>
      <div id="tutorialStepInfo" class="overlay-step-info"></div>
      <div class="overlay-buttons">
        <button id="tutorialPrevBtn" class="btn btn-secondary btn-sm">Anterior</button>
        <button id="tutorialNextBtn" class="btn btn-primary btn-sm">Pr√≥ximo</button>
        <button id="tutorialStartBtn" class="btn btn-primary btn-sm">Come√ßar partida</button>
        <button id="tutorialSkipBtn" class="btn btn-secondary btn-sm">Pular</button>
      </div>
    </div>
  </div>

  <!-- NOTIFICA√á√ÉO CENTRAL -->
  <div id="notification">
    <div id="notificationContent">
      <div id="notificationText"></div>
      <button id="notificationOkBtn" class="btn btn-secondary btn-sm">OK</button>
    </div>
  </div>

  <script>
    // ==========================
    // DEFINI√á√ÉO DAS CARTAS
    // ==========================

    const IMMUNE_CARDS = [
      {
        id: "neutrofilo",
        name: "Neutr√≥filo",
        short: "Neutr√≥filo",
        role: "neutrofilo",
        kind: "immune",
        description:
          "Soldado r√°pido da linha de frente. No jogo, ele √© bom para defender contra bact√©rias e alguns fungos."
      },
      {
        id: "macrofago",
        name: "Macr√≥fago",
        short: "Macr√≥fago",
        role: "macrofago",
        kind: "immune",
        description:
          "Lixeiro do corpo: engole invasores e mostra peda√ßos deles para outras c√©lulas. No jogo, ajuda contra bact√©rias, v√≠rus e fungos."
      },
      {
        id: "linfocito_b",
        name: "Linf√≥cito B",
        short: "Linf√≥cito B",
        role: "b",
        kind: "immune",
        description:
          "F√°brica de anticorpos. No jogo, √© usado para defender contra v√≠rus, bact√©rias, vermes e alergias (como se fosse IgE)."
      },
      {
        id: "linfocito_t",
        name: "Linf√≥cito T",
        short: "Linf√≥cito T",
        role: "t",
        kind: "immune",
        description:
          "Comandante e assassino de c√©lulas infectadas. No jogo, √© a defesa principal contra v√≠rus e algumas doen√ßas autoimunes."
      },
      {
        id: "eosinofilo",
        name: "Eosin√≥filo",
        short: "Eosin√≥filo",
        role: "eosinofilo",
        kind: "immune",
        description:
          "Guerreiro com ‚Äúgranadas‚Äù especiais. No jogo, √© muito bom contra vermes (helmintos) e alergias mais fortes."
      },
      {
        id: "mastocito_ige",
        name: "Mast√≥cito + IgE",
        short: "Mast√≥cito + IgE",
        role: "mastocito",
        kind: "immune",
        description:
          "Sentinela das alergias. No jogo, reage r√°pido em alergias (rinite, picada de inseto, alimentos, poeira, p√≥len) e ajuda contra vermes."
      },
      {
        id: "treg",
        name: "Linf√≥cito Treg",
        short: "Treg",
        role: "treg",
        kind: "immune",
        description:
          "Juiz da paz do sistema imune. No jogo, √© a carta que freia exageros, defende contra doen√ßas autoimunes e melhora alergias."
      },
      {
        id: "tecidos_normais",
        name: "Tecidos normais",
        short: "Tecidos",
        role: "tecido_normal",
        kind: "immune",
        description:
          "C√©lulas da pele, f√≠gado, p√¢ncreas, m√∫sculo e neur√¥nios. No jogo, lembram que existem ‚Äúcivis inocentes‚Äù que precisam ser protegidos nas autoimunidades."
      }
    ];

    const DISEASE_CARDS = [
      {
        id: "virus_generico",
        name: "V√≠rus (gen√©rico)",
        short: "V√≠rus",
        category: "viral",
        kind: "disease",
        effectiveRoles: ["t", "b", "macrofago", "neutrofilo"],
        description:
          "Invade por dentro das c√©lulas. No jogo, pode ser defendido por Linf√≥cito T, Linf√≥cito B (anticorpos), Macr√≥fagos e um pouco por Neutr√≥filos."
      },
      {
        id: "bacteria_generica",
        name: "Bact√©ria (gen√©rica)",
        short: "Bact√©ria",
        category: "bacteriana",
        kind: "disease",
        effectiveRoles: ["neutrofilo", "macrofago", "b"],
        description:
          "Invade o corpo por fora das c√©lulas. No jogo, Neutr√≥filos s√£o a defesa principal, com ajuda de Macr√≥fagos e anticorpos do Linf√≥cito B."
      },
      {
        id: "helmintos",
        name: "Helmintos (vermes)",
        short: "Helmintos",
        category: "verme",
        kind: "disease",
        effectiveRoles: ["eosinofilo", "mastocito", "b"],
        description:
          "Vermes grand√µes. No jogo, Eosin√≥filos, Mast√≥citos e Linf√≥citos B (como IgE) s√£o as melhores defesas."
      },
      {
        id: "rinite_alergica",
        name: "Rinite al√©rgica",
        short: "Rinite",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
        description:
          "Inflama√ß√£o do nariz por alergia. No jogo, Mast√≥citos, Eosin√≥filos e Linf√≥cito B (IgE) participam. Treg ajuda a controlar o exagero."
      },
      {
        id: "alergia_alimentos",
        name: "Alergia a alimentos",
        short: "Alergia alim.",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
        description:
          "O corpo reage demais a um alimento comum. No jogo, Mast√≥citos, Eosin√≥filos e Linf√≥citos B (IgE) aparecem. Treg tenta evitar ou diminuir a alergia."
      },
      {
        id: "picada_inseto",
        name: "Picada de inseto",
        short: "Picada",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "b"],
        description:
          "Rea√ß√£o local com vermelhid√£o e coceira. No jogo, Mast√≥citos s√£o os primeiros a reagir, com ajuda de Eosin√≥filos e anticorpos do Linf√≥cito B."
      },
      {
        id: "febre_reumatica",
        name: "Febre reum√°tica",
        short: "Febre reum.",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Depois de uma infec√ß√£o bacteriana, o corpo confunde o cora√ß√£o com o inimigo. No jogo, s√≥ Treg √© considerado uma defesa eficaz."
      },
      {
        id: "polen",
        name: "P√≥len",
        short: "P√≥len",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
        description:
          "Gr√£ozinho de planta que causa alergia em algumas pessoas. No jogo, Mast√≥citos, Eosin√≥filos e Linf√≥citos B (IgE) reagem, e Treg ajuda a acalmar."
      },
      {
        id: "poeira",
        name: "Poeira",
        short: "Poeira",
        category: "alergia",
        kind: "disease",
        effectiveRoles: ["mastocito", "eosinofilo", "b", "treg"],
        description:
          "Poeira de casa pode ser um gatilho de alergia. No jogo, Mast√≥citos, Eosin√≥filos e Linf√≥citos B (IgE) atuam, com Treg como freio."
      },
      {
        id: "falta_treg",
        name: "Falta de Treg",
        short: "Falta Treg",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Quando quase n√£o h√° ‚Äújuiz da paz‚Äù. No jogo, isso simboliza perda do freio: autoimunes e alergias ficam piores. Jogar Treg aqui representa recuperar o controle."
      },
      {
        id: "artrite_reumatoide",
        name: "Artrite reumatoide",
        short: "AR",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Autoimune nas articula√ß√µes. No jogo, s√≥ Treg √© tratado como defesa eficaz, pois representa frear a inflama√ß√£o exagerada contra as juntas."
      },
      {
        id: "dm1",
        name: "Diabetes Mellitus tipo 1",
        short: "DM1",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Autoimune contra as c√©lulas do p√¢ncreas que produzem insulina. No jogo, Treg √© a √∫nica carta que ‚Äútenta parar‚Äù esse ataque."
      },
      {
        id: "autoanticorpos",
        name: "Autoanticorpos",
        short: "Autoantic.",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Anticorpos que atacam o pr√≥prio corpo. No jogo, representam o erro do sistema imune em doen√ßas como l√∫pus, artrite reumatoide e outras."
      },
      {
        id: "lupus",
        name: "L√∫pus eritematoso sist√™mico",
        short: "L√∫pus",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Doen√ßa autoimune que pode pegar v√°rios √≥rg√£os ao mesmo tempo. No jogo, Treg √© a defesa porque simboliza o freio para tantos ataques errados."
      },
      {
        id: "doenca_celiaca",
        name: "Doen√ßa cel√≠aca",
        short: "Cel√≠aca",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Doen√ßa autoimune que aparece quando o corpo reage ao gl√∫ten e machuca o intestino. No jogo, Treg √© a carta que representa controlar esse ataque √†s mucosas."
      },
      {
        id: "hashimoto",
        name: "Tireoidite de Hashimoto",
        short: "Hashimoto",
        category: "autoimune",
        kind: "disease",
        effectiveRoles: ["treg"],
        description:
          "Autoimune da tireoide. No jogo, Treg √© a defesa principal, mostrando que o freio evita que o corpo destrua a pr√≥pria gl√¢ndula."
      }
    ];

    // ==========================
    // ESTADO DO JOGO
    // ==========================

    let deck = [];
    let discardPile = [];
    let players = [];
    let currentPlayer = 0; // 0 = voc√™, 1 = bot
    let gameOver = false;
    let selectedCardIndex = null;
    let pendingAttack = null; // { targetIndex, diseaseCard }
    let gameStarted = false;

    // ==========================
    // TUTORIAL
    // ==========================

    const tutorialSteps = [
      {
        title: "Sobre o que √© este jogo?",
        body: `
          <p>Voc√™ est√° controlando o <strong>sistema imunol√≥gico humano</strong> üß¨.</p>
          <p>O bot √© um <strong>pat√≥geno inimigo</strong> ü§ñ.</p>
          <ul>
            <li><strong>Objetivo:</strong> ficar sem cartas na m√£o antes do bot.</li>
            <li>Voc√™ usa cartas para <strong>atacar</strong> (doen√ßas) e <strong>defender</strong> (c√©lulas).</li>
          </ul>
        `
      },
      {
        title: "Como ganhar a partida",
        body: `
          <ul>
            <li>Use doen√ßas (‚öî) para colocar o oponente sob <strong>press√£o</strong>.</li>
            <li>Use c√©lulas (üõ°) para se <strong>defender</strong> das doen√ßas que ca√≠rem sobre voc√™.</li>
            <li><strong>Quem ficar sem cartas na m√£o primeiro vence</strong>.</li>
          </ul>
        `
      },
      {
        title: "Dois tipos de cartas principais",
        body: `
          <p>Existem dois grupos:</p>
          <ul>
            <li><strong>üõ° C√©lulas do sistema imune (verde):</strong> usadas para se <strong>defender</strong>.</li>
            <li><strong>‚öî Doen√ßas (v√°rias cores):</strong> usadas para <strong>atacar</strong> o oponente.</li>
          </ul>
          <p>A cor da carta de doen√ßa indica o tipo (v√≠rus, bact√©ria, alergia, verme, autoimune, etc.).</p>
        `
      },
      {
        title: "Como atacar",
        body: `
          <p>No seu turno, voc√™ pode:</p>
          <ul>
            <li><strong>Jogar uma carta de doen√ßa (‚öî):</strong> o bot fica sob <strong>ataque</strong>.</li>
            <li>Ele ter√° que se defender com uma <strong>c√©lula eficaz</strong> üõ° ou comprar 1 carta.</li>
          </ul>
          <p>Se ele n√£o conseguir se defender bem, <strong>compra carta</strong> e voc√™ se aproxima da vit√≥ria.</p>
        `
      },
      {
        title: "Como se defender",
        body: `
          <p>Quando aparecer em ‚ÄúSitua√ß√£o‚Äù algo como:</p>
          <p><em>Voc√™ est√° sob ataque de V√≠rus...</em></p>
          <ul>
            <li>Para se defender, clique numa carta verde (üõ°) e veja se ela √© <strong>eficaz</strong>.</li>
            <li>Se a carta n√£o for boa para aquela doen√ßa, voc√™ compra 1 carta.</li>
          </ul>
          <p>Se n√£o quiser arriscar, voc√™ pode simplesmente <strong>comprar 1 carta</strong> para encerrar o ataque.</p>
        `
      }
    ];

    let tutorialCurrentStep = 0;

    // ==========================
    // UTILIT√ÅRIAS
    // ==========================

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createDeck() {
      const newDeck = [];
      IMMUNE_CARDS.forEach(cardDef => {
        for (let i = 0; i < 4; i++) newDeck.push({ ...cardDef });
      });
      DISEASE_CARDS.forEach(cardDef => {
        for (let i = 0; i < 2; i++) newDeck.push({ ...cardDef });
      });
      return shuffle(newDeck);
    }

    function drawCardFromDeck() {
      if (deck.length === 0) {
        if (discardPile.length > 1) {
          const top = discardPile.pop();
          deck = shuffle(discardPile);
          discardPile = [top];
        } else {
          return null;
        }
      }
      return deck.pop();
    }

    function isImmuneCard(card) {
      return card && card.kind === "immune";
    }

    function isDiseaseCard(card) {
      return card && card.kind === "disease";
    }

    function isEffectiveDefense(immuneCard, diseaseCard) {
      if (!immuneCard || !diseaseCard) return false;
      if (!isImmuneCard(immuneCard) || !isDiseaseCard(diseaseCard)) return false;
      return diseaseCard.effectiveRoles.includes(immuneCard.role);
    }

    function cardCssClass(card) {
      if (!card) return "card";
      if (isImmuneCard(card)) return "card immune";
      switch (card.category) {
        case "autoimune":  return "card disease-autoimune";
        case "viral":      return "card disease-viral";
        case "bacteriana": return "card disease-bacteriana";
        case "verme":      return "card disease-verme";
        case "fungo":      return "card disease-fungo";
        case "alergia":    return "card disease-alergia";
        default:           return "card";
      }
    }

    function describeCategory(card) {
      if (!card || !isDiseaseCard(card)) return "";
      switch (card.category) {
        case "autoimune":  return "Doen√ßa autoimune";
        case "viral":      return "Doen√ßa viral";
        case "bacteriana": return "Doen√ßa bacteriana";
        case "verme":      return "Infec√ß√£o por verme (helminto)";
        case "fungo":      return "Infec√ß√£o f√∫ngica";
        case "alergia":    return "Doen√ßa al√©rgica";
        default:           return "";
      }
    }

    function getDiseaseCategoryLabel(card) {
      if (!card || !isDiseaseCard(card)) return "";
      switch (card.category) {
        case "autoimune":  return "Autoimune";
        case "viral":      return "Viral";
        case "bacteriana": return "Bacteriana";
        case "verme":      return "Verme";
        case "fungo":      return "F√∫ngica";
        case "alergia":    return "Al√©rgica";
        default:           return "";
      }
    }

    function getImmuneRoleLabel(card) {
      if (!card || !isImmuneCard(card)) return "";
      if (card.role === "treg") return "Reguladora";
      if (card.role === "tecido_normal") return "Tecidos do corpo";
      return "Defesa";
    }

    function getCardLabelHTML(card) {
      if (!card) return "";
      let icon = "";
      let typeLabel = "";
      let middleLabel = "";
      if (isImmuneCard(card)) {
        icon = "üõ°";
        typeLabel = "C√©lula";
        middleLabel = getImmuneRoleLabel(card);
      } else if (isDiseaseCard(card)) {
        icon = "‚öî";
        typeLabel = "Doen√ßa";
        middleLabel = getDiseaseCategoryLabel(card);
      }
      const name = card.short || card.name;
      return `
        <div class="card-top">
          <span>${icon}</span>
          <span class="card-type">${typeLabel}${middleLabel ? " ¬∑ " + middleLabel : ""}</span>
        </div>
        <div class="card-name">${name}</div>
      `;
    }

    // Efeito antigo, mantido por seguran√ßa se algum Th* aparecer
    function applyThMassDiscard(playerIndex, card) {
      if (!card || !isImmuneCard(card)) return;
      const player = players[playerIndex];
      if (!player) return;

      let roleToDiscard = null;
      if (card.role === "th1") roleToDiscard = "macrofago";
      else if (card.role === "th2") roleToDiscard = "eosinofilo";
      else if (card.role === "th17") roleToDiscard = "neutrofilo";

      if (!roleToDiscard) return;

      const remaining = [];
      player.hand.forEach(c => {
        if (c.role === roleToDiscard) discardPile.push(c);
        else remaining.push(c);
      });
      player.hand = remaining;
    }

    // Delay para o bot "pensar"
    function getBotThinkingDelay() {
      return 1200 + Math.floor(Math.random() * 1000); // entre ~1,2s e ~2,2s
    }

    // ==========================
    // NOTIFICA√á√ÉO CENTRAL
    // ==========================

    const notificationEl = document.getElementById("notification");
    const notificationContentEl = document.getElementById("notificationContent");
    const notificationTextEl = document.getElementById("notificationText");
    const notificationOkBtnEl = document.getElementById("notificationOkBtn");

    let notificationQueue = [];
    let notificationVisible = false;

    function showNotification(message) {
      notificationQueue.push(message);
      if (!notificationVisible) {
        showNextNotification();
      }
    }

    function showNextNotification() {
      if (notificationQueue.length === 0) {
        notificationVisible = false;
        notificationEl.classList.remove("visible");
        return;
      }
      notificationVisible = true;
      const message = notificationQueue.shift();
      if (notificationTextEl) {
        notificationTextEl.textContent = message;
      }
      notificationEl.classList.add("visible");
    }

    if (notificationOkBtnEl) {
      notificationOkBtnEl.addEventListener("click", () => {
        notificationEl.classList.remove("visible");
        setTimeout(() => {
          showNextNotification();
        }, 120);
      });
    }

    // ==========================
    // DOM ELEMENTOS
    // ==========================

    const screenStartEl = document.getElementById("screen-start");
    const screenGameEl = document.getElementById("screen-game");
    const startPlayBtnEl = document.getElementById("startPlayBtn");
    const startHowBtnEl = document.getElementById("startHowBtn");

    const playerHandEl = document.getElementById("playerHand");
    const botHandEl = document.getElementById("botHand");
    const discardPileCardEl = document.getElementById("discardPileCard");
    const drawPileCardEl = document.getElementById("drawPileCard");
    const statusEl = document.getElementById("status");
    const deckSizeInfoEl = document.getElementById("deckSizeInfo");
    const turnInfoEl = document.getElementById("turnInfo");
    const phaseInfoEl = document.getElementById("phaseInfo");
    const drawBtnEl = document.getElementById("drawBtn");
    const newGameBtnEl = document.getElementById("newGameBtn");
    const lastCardInfoEl = document.getElementById("lastCardInfo");
    const helpBtnEl = document.getElementById("helpBtn");
    const playerCardCountEl = document.getElementById("playerCardCount");
    const botCardCountEl = document.getElementById("botCardCount");

    const cardPreviewEl = document.getElementById("cardPreview");
    const cardPreviewDescriptionEl = document.getElementById("cardPreviewDescription");
    const cardPreviewTitleEl = document.getElementById("cardPreviewTitle");
    const playSelectedBtn = document.getElementById("playSelectedBtn");
    const cancelSelectedBtn = document.getElementById("cancelSelectedBtn");

    const tutorialOverlayEl = document.getElementById("tutorialOverlay");
    const tutorialTitleEl = document.getElementById("tutorialTitle");
    const tutorialBodyEl = document.getElementById("tutorialBody");
    const tutorialStepInfoEl = document.getElementById("tutorialStepInfo");
    const tutorialPrevBtnEl = document.getElementById("tutorialPrevBtn");
    const tutorialNextBtnEl = document.getElementById("tutorialNextBtn");
    const tutorialStartBtnEl = document.getElementById("tutorialStartBtn");
    const tutorialSkipBtnEl = document.getElementById("tutorialSkipBtn");

    function showStartScreen() {
      screenStartEl.classList.add("active");
      screenGameEl.classList.remove("active");
    }

    function showGameScreen() {
      screenGameEl.classList.add("active");
      screenStartEl.classList.remove("active");
    }

    function updateStatus(text) {
      statusEl.textContent = text;
    }

    // ==========================
    // CONTROLE DO JOGO
    // ==========================

    function dealInitialHands() {
      players = [
        { name: "Voc√™", hand: [] },
        { name: "Bot", hand: [] }
      ];
      const initialCards = 7;
      for (let i = 0; i < initialCards; i++) {
        players[0].hand.push(drawCardFromDeck());
        players[1].hand.push(drawCardFromDeck());
      }
      let firstCard = drawCardFromDeck();
      let tries = 0;
      while (firstCard && isDiseaseCard(firstCard) && tries < 20) {
        deck.unshift(firstCard);
        firstCard = drawCardFromDeck();
        tries++;
      }
      if (firstCard) discardPile = [firstCard];
      else discardPile = [];
      pendingAttack = null;
    }

    function startGame() {
      showGameScreen();
      deck = createDeck();
      discardPile = [];
      gameOver = false;
      currentPlayer = 0;
      selectedCardIndex = null;
      pendingAttack = null;
      gameStarted = true;
      hideCardPreview();
      notificationQueue = [];
      notificationVisible = false;
      dealInitialHands();
      updateStatus("O jogo come√ßou. Use ‚öî para atacar e üõ° para se defender. Seu objetivo √© ficar sem cartas.");
      showNotification("O jogo come√ßou! Fique sem cartas na m√£o para vencer.");
      render();
      if (currentPlayer === 1 && !gameOver) {
        setTimeout(botTurn, getBotThinkingDelay());
      }
    }

    function checkWin(playerIndex) {
      if (players[playerIndex].hand.length === 0) {
        gameOver = true;
        if (playerIndex === 0) {
          updateStatus("Voc√™ ficou sem cartas. Vit√≥ria do sistema imune humano! üéâ");
          showNotification("Vit√≥ria! Seu sistema imune venceu! üéâ");
        } else {
          updateStatus("O bot ficou sem cartas. O pat√≥geno venceu desta vez. üòà");
          showNotification("O pat√≥geno venceu desta vez. üòà");
        }
      }
    }

    function endTurn() {
      if (gameOver) return;
      currentPlayer = (currentPlayer + 1) % players.length;
      selectedCardIndex = null;
      hideCardPreview();
      render();
      if (currentPlayer === 1 && !gameOver) {
        setTimeout(botTurn, getBotThinkingDelay());
      } else if (!gameOver) {
        if (pendingAttack && pendingAttack.targetIndex === 0) {
          const diseaseName = pendingAttack.diseaseCard.name;
          const shortName = pendingAttack.diseaseCard.short || diseaseName;
          updateStatus("‚ö† Voc√™ est√° sob ataque de " + diseaseName + ". Jogue defesa üõ° eficaz ou compre 1 carta.");
          showNotification("‚ö† Ataque de " + shortName + "! Use uma defesa üõ° ou compre 1 carta.");
        } else {
          updateStatus("Seu turno. Voc√™ pode jogar uma carta ou comprar 1 carta.");
        }
      }
    }

    function canPlayCardForCurrentState(card) {
      if (gameOver || currentPlayer !== 0) return false;
      if (!card) return false;
      if (pendingAttack && pendingAttack.targetIndex === 0) {
        return isImmuneCard(card);
      }
      return true;
    }

    function handlePlayerCardClick(index) {
      if (gameOver || currentPlayer !== 0) return;
      const player = players[0];
      const card = player.hand[index];
      selectedCardIndex = index;
      showCardPreview(card);
      renderPlayerHand();
    }

    function playerPlaySelectedCard() {
      if (selectedCardIndex === null) return;
      const player = players[0];
      const card = player.hand[selectedCardIndex];
      if (!canPlayCardForCurrentState(card)) {
        if (pendingAttack && pendingAttack.targetIndex === 0) {
          updateStatus("Voc√™ est√° sob ataque e s√≥ pode jogar c√©lulas de defesa üõ° ou comprar 1 carta.");
          showNotification("Sob ataque: jogue defesa üõ° ou compre 1 carta.");
        } else {
          updateStatus("Neste momento, esta carta n√£o pode ser jogada.");
        }
        return;
      }
      const cardEl = playerHandEl.children[selectedCardIndex];
      playCard(0, selectedCardIndex, cardEl);
    }

    function playerDrawCard() {
      if (gameOver || currentPlayer !== 0) return;
      const player = players[0];
      if (pendingAttack && pendingAttack.targetIndex === 0) {
        const newCard = drawCardFromDeck();
        if (newCard) {
          player.hand.push(newCard);
          updateStatus(
            "Voc√™ escolheu n√£o se defender de " + pendingAttack.diseaseCard.name +
            " e comprou 1 carta. O ataque terminou."
          );
          const shortName = pendingAttack.diseaseCard.short || pendingAttack.diseaseCard.name;
          showNotification("Voc√™ n√£o se defendeu de " + shortName + " e comprou 1 carta.");
        } else {
          updateStatus("N√£o h√° mais cartas para comprar.");
        }
        pendingAttack = null;
        render();
        endTurn();
        return;
      }
      const newCard = drawCardFromDeck();
      if (newCard) {
        player.hand.push(newCard);
        updateStatus("Voc√™ comprou 1 carta e passou o turno.");
      } else {
        updateStatus("N√£o h√° mais cartas para comprar.");
      }
      render();
      endTurn();
    }

    function playCard(playerIndex, cardIndex, sourceElementForAnimation) {
      if (gameOver) return;
      const player = players[playerIndex];
      const card = player.hand[cardIndex];
      if (!card) return;

      if (sourceElementForAnimation) {
        animateCardToDiscard(sourceElementForAnimation, card);
      }

      player.hand.splice(cardIndex, 1);
      discardPile.push(card);
      applyThMassDiscard(playerIndex, card);

      if (pendingAttack && pendingAttack.targetIndex === playerIndex) {
        resolveDefense(playerIndex, card);
        return;
      }

      if (isDiseaseCard(card)) {
        const target = (playerIndex + 1) % players.length;
        pendingAttack = { targetIndex: target, diseaseCard: card };
        updateStatus(
          player.name + " jogou a doen√ßa " + card.name +
          " (‚öî) e colocou " + players[target].name + " sob ataque."
        );
        if (target === 0) {
          const shortName = card.short || card.name;
          showNotification("‚öî " + player.name + " lan√ßou " + shortName + " em voc√™!");
        }
      } else {
        updateStatus(player.name + " jogou a c√©lula " + card.name + " (üõ°).");
      }

      checkWin(playerIndex);
      render();
      if (!gameOver) endTurn();
    }

    function resolveDefense(playerIndex, immuneCard) {
      const attack = pendingAttack;
      pendingAttack = null;
      const opponentIndex = (playerIndex + 1) % players.length;
      const defender = players[playerIndex];
      const opponent = players[opponentIndex];

      if (!isImmuneCard(immuneCard)) {
        const newCard = drawCardFromDeck();
        if (newCard) defender.hand.push(newCard);
        updateStatus(defender.name + " tentou se defender com uma carta inv√°lida e comprou 1 carta.");
        if (playerIndex === 0) showNotification("Defesa inv√°lida. Voc√™ comprou 1 carta.");
        render();
        endTurn();
        return;
      }

      const effective = isEffectiveDefense(immuneCard, attack.diseaseCard);
      const shortName = attack.diseaseCard.short || attack.diseaseCard.name;

      if (effective) {
        checkWin(playerIndex);
        if (gameOver) {
          render();
          return;
        }
        const newCard = drawCardFromDeck();
        if (newCard) opponent.hand.push(newCard);
        updateStatus(
          defender.name + " se defendeu com " + immuneCard.name +
          " (üõ°) contra " + attack.diseaseCard.name +
          " (‚öî). O atacante (" + opponent.name + ") comprou 1 carta."
        );
        if (playerIndex === 0) {
          showNotification("Defesa bem-sucedida contra " + shortName + "! O bot comprou 1 carta.");
        }
      } else {
        const newCard = drawCardFromDeck();
        if (newCard) defender.hand.push(newCard);
        updateStatus(
          defender.name + " tentou se defender com " + immuneCard.name +
          " (üõ°) contra " + attack.diseaseCard.name +
          " (‚öî), mas n√£o foi eficaz. " + defender.name + " comprou 1 carta."
        );
        if (playerIndex === 0) {
          showNotification("Sua defesa n√£o foi eficaz contra " + shortName + ". Voc√™ comprou 1 carta.");
        }
      }

      render();
      if (!gameOver) endTurn();
    }

    function botTurn() {
      if (gameOver || currentPlayer !== 1) return;
      const bot = players[1];

      if (pendingAttack && pendingAttack.targetIndex === 1) {
        const disease = pendingAttack.diseaseCard;

        let effectiveIndex = -1;
        for (let i = 0; i < bot.hand.length; i++) {
          const card = bot.hand[i];
          if (isImmuneCard(card) && isEffectiveDefense(card, disease)) {
            effectiveIndex = i;
            break;
          }
        }
        if (effectiveIndex !== -1) {
          playCard(1, effectiveIndex, null);
          return;
        }

        let anyImmuneIndex = -1;
        for (let i = 0; i < bot.hand.length; i++) {
          if (isImmuneCard(bot.hand[i])) {
            anyImmuneIndex = i;
            break;
          }
        }
        if (anyImmuneIndex !== -1) {
          playCard(1, anyImmuneIndex, null);
          return;
        }

        const newCard = drawCardFromDeck();
        if (newCard) bot.hand.push(newCard);
        updateStatus("Bot n√£o conseguiu se defender de " + disease.name + " (‚öî) e comprou 1 carta.");
        pendingAttack = null;
        render();
        endTurn();
        return;
      }

      let diseaseIndex = -1;
      for (let i = 0; i < bot.hand.length; i++) {
        if (isDiseaseCard(bot.hand[i])) {
          diseaseIndex = i;
          break;
        }
      }
      if (diseaseIndex !== -1) {
        playCard(1, diseaseIndex, null);
        return;
      }

      let anyImmuneIndex = -1;
      for (let i = 0; i < bot.hand.length; i++) {
        if (isImmuneCard(bot.hand[i])) {
          anyImmuneIndex = i;
          break;
        }
      }
      if (anyImmuneIndex !== -1) {
        playCard(1, anyImmuneIndex, null);
        return;
      }

      const newCard = drawCardFromDeck();
      if (newCard) {
        bot.hand.push(newCard);
        updateStatus("Bot comprou 1 carta e passou o turno.");
      } else {
        updateStatus("Bot tentou comprar carta, mas n√£o havia mais no baralho.");
      }
      render();
      endTurn();
    }

    // ==========================
    // RENDERIZA√á√ÉO
    // ==========================

    function render() {
      renderPlayerHand();
      renderBotHand();

      const top = discardPile[discardPile.length - 1];
      if (top) {
        discardPileCardEl.className = cardCssClass(top) + " stack-card";
        discardPileCardEl.innerHTML = getCardLabelHTML(top);
        if (isDiseaseCard(top)) {
          lastCardInfoEl.textContent =
            describeCategory(top) + ". Esta √© a √∫ltima carta jogada na mesa.";
        } else {
          lastCardInfoEl.textContent =
            "C√©lula imune jogada. Pode ser usada como defesa quando houver um ataque.";
        }
      } else {
        discardPileCardEl.className = "card stack-card";
        discardPileCardEl.innerHTML = "";
        lastCardInfoEl.textContent = "";
      }

      drawPileCardEl.className = "card stack-card face-down";
      deckSizeInfoEl.textContent = `Cartas restantes no baralho: ${deck.length}`;

      if (players[0]) playerCardCountEl.textContent = players[0].hand.length;
      if (players[1]) botCardCountEl.textContent = players[1].hand.length;

      turnInfoEl.textContent = players[currentPlayer]?.name || "-";

      if (pendingAttack) {
        const targetName = players[pendingAttack.targetIndex].name;
        const diseaseName = pendingAttack.diseaseCard.short || pendingAttack.diseaseCard.name;
        phaseInfoEl.textContent = `Ataque: ${diseaseName} em ${targetName}`;
      } else {
        phaseInfoEl.textContent = "Sem ataque ativo";
      }

      drawBtnEl.disabled = gameOver || currentPlayer !== 0;
    }

    function renderPlayerHand() {
      playerHandEl.innerHTML = "";
      const player = players[0];
      if (!player) return;
      player.hand.forEach((card, index) => {
        const cardDiv = document.createElement("div");
        let cls = cardCssClass(card) + " player-card";
        if (index === selectedCardIndex) cls += " selected";
        cardDiv.className = cls;
        cardDiv.innerHTML = getCardLabelHTML(card);
        cardDiv.title = "Toque para ver a explica√ß√£o e decidir jogar";
        cardDiv.addEventListener("click", () => handlePlayerCardClick(index));
        playerHandEl.appendChild(cardDiv);
      });
    }

    function renderBotHand() {
      botHandEl.innerHTML = "";
      const bot = players[1];
      if (!bot) return;
      bot.hand.forEach(() => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card face-down";
        botHandEl.appendChild(cardDiv);
      });
    }

    function animateCardToDiscard(fromElement, card) {
      if (!fromElement || !discardPileCardEl) return;
      const fromRect = fromElement.getBoundingClientRect();
      const toRect = discardPileCardEl.getBoundingClientRect();
      const flying = document.createElement("div");
      flying.className = cardCssClass(card) + " flying-card";
      flying.innerHTML = getCardLabelHTML(card);
      flying.style.position = "fixed";
      flying.style.left = fromRect.left + "px";
      flying.style.top = fromRect.top + "px";
      flying.style.width = fromRect.width + "px";
      flying.style.height = fromRect.height + "px";
      flying.style.pointerEvents = "none";
      flying.style.zIndex = "1500";
      flying.style.transition = "transform 0.35s ease-out, opacity 0.35s ease-out";
      document.body.appendChild(flying);
      const dx = toRect.left - fromRect.left;
      const dy = toRect.top - fromRect.top;
      requestAnimationFrame(() => {
        flying.style.transform = `translate(${dx}px, ${dy}px) scale(0.9)`;
        flying.style.opacity = "0.1";
      });
      flying.addEventListener("transitionend", () => flying.remove());
    }

    // ==========================
    // PR√â-VISUALIZA√á√ÉO DA CARTA
    // ==========================

    function showCardPreview(card) {
      if (!card) return;
      cardPreviewTitleEl.textContent = card.name;
      let baseInfo = "";
      if (isImmuneCard(card)) {
        baseInfo += `<strong>Tipo:</strong> C√©lula do sistema imune (üõ°)<br/>`;
        baseInfo += `<strong>Fun√ß√£o l√∫dica:</strong> ${card.description}<br/>`;
      } else if (isDiseaseCard(card)) {
        baseInfo += `<strong>Tipo:</strong> ${describeCategory(card)} (‚öî)<br/>`;
        baseInfo += `<strong>Descri√ß√£o l√∫dica:</strong> ${card.description}<br/>`;
        baseInfo += `<br/><strong>Defesas eficazes contra ela:</strong> `;
        const roles = card.effectiveRoles.map(r => {
          const def = IMMUNE_CARDS.find(c => c.role === r);
          return def ? def.name : r;
        });
        baseInfo += roles.join(", ") + `.<br/>`;
      }
      cardPreviewDescriptionEl.innerHTML = baseInfo;
      const canPlay = canPlayCardForCurrentState(card);
      playSelectedBtn.disabled = !canPlay;
      cardPreviewEl.classList.add("visible");
    }

    function hideCardPreview() {
      cardPreviewEl.classList.remove("visible");
    }

    // ==========================
    // TUTORIAL
    // ==========================

    function updateTutorialContent() {
      const step = tutorialSteps[tutorialCurrentStep];
      tutorialTitleEl.textContent = step.title;
      tutorialBodyEl.innerHTML = step.body;
      tutorialStepInfoEl.textContent =
        `Passo ${tutorialCurrentStep + 1} de ${tutorialSteps.length}`;
      tutorialPrevBtnEl.disabled = tutorialCurrentStep === 0;
      tutorialNextBtnEl.style.display =
        tutorialCurrentStep < tutorialSteps.length - 1 ? "inline-flex" : "none";
      tutorialStartBtnEl.style.display =
        tutorialCurrentStep === tutorialSteps.length - 1 ? "inline-flex" : "none";
    }

    function openTutorial() {
      tutorialCurrentStep = 0;
      updateTutorialContent();
      tutorialOverlayEl.classList.remove("hidden");
    }

    function closeTutorial(startIfNeeded) {
      tutorialOverlayEl.classList.add("hidden");
      if (startIfNeeded && !gameStarted) startGame();
    }

    // ==========================
    // EVENTOS
    // ==========================

    drawBtnEl.addEventListener("click", playerDrawCard);
    newGameBtnEl.addEventListener("click", () => {
      startGame();
    });
    playSelectedBtn.addEventListener("click", playerPlaySelectedCard);
    cancelSelectedBtn.addEventListener("click", () => {
      selectedCardIndex = null;
      hideCardPreview();
      renderPlayerHand();
    });
    helpBtnEl.addEventListener("click", () => {
      openTutorial();
    });

    tutorialPrevBtnEl.addEventListener("click", () => {
      if (tutorialCurrentStep > 0) {
        tutorialCurrentStep--;
        updateTutorialContent();
      }
    });
    tutorialNextBtnEl.addEventListener("click", () => {
      if (tutorialCurrentStep < tutorialSteps.length - 1) {
        tutorialCurrentStep++;
        updateTutorialContent();
      }
    });
    tutorialStartBtnEl.addEventListener("click", () => {
      closeTutorial(true);
    });
    tutorialSkipBtnEl.addEventListener("click", () => {
      closeTutorial(!gameStarted);
    });

    startPlayBtnEl.addEventListener("click", () => {
      startGame();
    });

    startHowBtnEl.addEventListener("click", () => {
      openTutorial();
    });

    // Ao carregar, mostra s√≥ a tela inicial
    showStartScreen();
  </script>
</body>
</html>
